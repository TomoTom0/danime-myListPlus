/*!
 * ⢀⢀⢀⢀⢀⢀⢀⢀⣄⣔⣔⣗⣝⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⢾⢀⢀⢀⢀⢀⢀⢀⠰⡘⡔⢜⠔⢜⠌⡆⢔⢀⠄
 * ⢀⢀⢀⢀⢀⣀⢮⢯⣺⣪⡺⣜⢮⢮⡳⣕⡗⣗⢗⣳⢳⡳⡳⣓⡗⣗⢗⣳⢳⡳⡳⣓⡗⡗⡹⢨⠂⢀⢀⢀⢀⢀⢀⢨⡪⡨⠢⡣⡑⡱⢨⠢⢣⠱⡨⡂⡀
 * ⢀⢀⢀⠠⡲⣝⣕⣗⢵⢵⢝⢮⡳⡳⣝⢮⡺⡮⣳⢳⡳⣝⣝⢞⢞⢮⡳⣳⢳⢝⢝⠪⡊⡢⡊⡲⢀⢀⢀⢀⢀⢀⢀⢸⢽⡹⡵⣌⡪⡨⢢⠣⡑⢕⢌⢮⢮⡢
 * ⢀⢀⡠⡯⣫⣺⡪⡮⡳⣝⢽⢵⢝⣝⢮⡳⣝⢞⢮⡳⣝⢮⢮⡫⣏⢗⣝⠮⡋⡪⡘⡌⡪⠢⡱⡘⠄⢀⢀⢀⢀⢀⢀⢸⡳⣝⣝⢮⣺⣪⡢⠣⡑⡱⡬⣳⢳⢝⣖⢀
 * ⢀⣘⢮⢯⡺⣪⢮⢏⢯⢮⡳⣝⣕⡗⣗⣝⢮⣫⡳⣝⢮⡳⡳⣝⠮⡫⡘⡌⡊⡆⢕⢌⢪⢸⡰⣽⠁⢀⢀⢀⢀⢀⢀⢸⢘⢺⢼⢕⡗⣮⡺⣝⢮⡫⣞⢮⢫⢑⠕⢍
 * ⢠⣪⣳⢳⢝⢮⡳⡽⡹⡵⣝⢞⣜⡞⣞⢮⡳⡵⣝⢮⡳⡝⡝⢌⠪⢢⢑⢌⢪⠨⡢⡱⣎⣗⣝⢾⢀⢀⢀⢀⢀⢀⢀⢰⢑⢜⢮⡳⣝⢮⡺⡮⡳⣝⢮⡪⡢⡑⡅⡣⢡
 * ⣔⢧⡳⡽⡹⡵⣝⢽⡹⡵⣝⣕⣗⣝⢮⡳⣝⢞⢮⢳⢑⢕⢘⢌⠪⡊⠢⠑⠘⠈⠊⠋⠚⠪⠮⣻⠄⢀⢀⢀⢀⢀⢀⢰⣕⢗⣗⣝⢮⡳⣝⢮⡻⣪⡳⡽⣕⢧⡪⡘⠔⠄
 * ⢮⡳⣝⢮⢏⢯⢮⡳⣝⢞⢮⡺⣜⢮⡳⣝⢮⡫⡯⣆⠣⡂⡇⠊⠈⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠈⢀⢀⢀⢀⢀⢀⢀⣸⢮⡳⣕⢗⣗⣝⠮⡳⢹⠪⢯⡺⣪⡳⣝⢵⣕⠅
 * ⡳⣝⢮⡫⣏⢯⣺⢺⡪⡯⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡳⠅⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡘⢧⡻⣪⡳⡵⡡⡃⢎⠢⢍⢆⢛⢮⡫⡮⡳⣕⠇
 * ⣝⢮⡳⣝⢮⡳⣕⢷⢝⢽⣹⣪⡳⣝⢮⡳⡝⢌⢍⠗⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠸⡐⢍⢺⡪⡯⡦⡣⡑⢕⢑⢌⢮⡳⣝⢽⡹⡪⡁
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⢗⢵⢵⢝⢮⡳⣝⢎⢊⢆⠁⢀⢀⢀⢀⢀⢀⢀⢀⡠⠠⡄⡄⢄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢱⡱⣕⢷⢝⢮⡫⡮⡯⡳⡽⡹⡵⣝⠮⡣⠣⡑⠄
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢮⢏⢯⢮⢏⢷⢝⢮⡣⢱⢀⢀⢀⢀⢀⢀⢀⢀⡴⡫⣮⡳⣌⡪⡂⢇⢆⢀⢀⢀⢀⢀⢀⢀⢀⢼⢝⢮⡳⣝⢗⢽⣹⡪⣏⢯⡫⣋⢪⢘⢌⢪⠸⡀
 * ⣝⢮⡳⣝⢮⡳⣝⢮⡳⡽⣝⢮⣫⡳⡽⣕⢇⠕⢀⢀⢀⢀⢀⢀⢀⡸⠨⡫⢺⡺⣺⡪⡮⡢⡅⣃⢀⢀⢀⢀⢀⢀⢀⢸⢹⡳⣝⢮⣫⡳⡵⣝⢎⢇⠪⠢⡑⡌⢆⢕⢑⠄
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⡞⡮⡳⡵⣝⢞⢮⡣⡃⢀⢀⢀⢀⢀⢀⢐⠸⡨⡊⡢⡱⠱⣝⢮⢯⡳⣲⢀⢀⢀⢀⢀⢀⢀⠸⡐⡜⢜⢓⢕⠝⡍⡢⢱⢐⢍⢪⢘⠌⡆⣕⢼⠅
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡫⡯⡺⡮⣫⡳⡕⡂⢀⢀⢀⢀⢀⢀⢀⢇⢪⠨⡒⡌⢕⠔⢍⢺⢺⣺⠁⢀⢀⢀⢀⢀⢀⢡⢃⢎⢢⠱⡨⡊⡢⡑⢕⠌⡆⢕⢬⡺⣺⡪⡯⡃
 * ⣝⢮⡳⣝⢮⡳⣝⢮⣫⡳⣝⢮⡻⣪⡳⣝⢎⢌⢀⢀⢀⢀⢀⢀⢀⢱⠡⡱⡨⡊⢆⠣⠣⡑⡔⢍⢀⢀⢀⢀⢀⢀⢀⠌⡆⡪⠢⡱⢨⢊⢢⢑⢅⢕⢼⣪⡳⣝⢮⠺⡩⠂
 * ⢮⡳⣝⢮⡳⣝⢮⣳⡣⡯⡮⡳⣝⢮⡫⣮⢣⠪⡀⢀⢀⢀⢀⢀⢀⢀⠣⡊⡢⢪⢘⢌⢕⢑⠜⢀⢀⢀⢀⢀⢀⢀⢀⢸⢦⣑⢕⠸⡐⡅⣕⣜⢮⢯⡳⡳⡝⡪⠪⡘⡌⡂
 * ⡳⣝⢮⡳⣝⢮⡳⡵⣝⢮⡫⡯⡮⡳⣝⢮⡣⡑⡅⡀⢀⢀⢀⢀⢀⢀⢀⠈⠘⠐⠕⠌⠂⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢼⡳⣓⣗⣝⢮⣫⡺⡼⣕⢗⠝⡌⢆⢕⢑⠕⢌⠂
 * ⣝⢮⡳⣝⢮⡳⡽⣕⢗⣗⣝⢮⡫⡯⡮⣳⢕⠌⡆⠥⡀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢘⢝⢮⡺⡼⣕⢗⣝⠞⡌⢆⠣⡊⡆⠕⡅⢕⡑⠅
 * ⢮⡳⣝⢮⡳⣝⡞⡮⡳⣕⢗⣗⣝⢮⢯⢮⡣⢱⢘⢌⠆⡄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⠢⣑⠱⡐⡕⣝⣞⢮⣳⠱⡑⠜⡌⡪⢌⢪⢘⢌⠆⢎⠂
 * ⡳⣝⢮⡳⣝⢞⢮⡫⡯⡮⡳⣕⣗⣝⢮⡳⡕⡑⡌⢆⠕⡜⠔⣄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⡐⢕⠸⡨⡂⡣⡱⢨⢺⢜⣕⡇⡕⠬⡱⢨⢊⢢⠱⡨⡂⢇⢕⠁
 * ⣝⢮⡳⣝⢮⢏⣗⣝⢮⡫⡯⡺⣜⢮⡳⣝⢎⢌⠪⡂⢇⠪⡊⡮⣻⡲⡦⡤⣠⣀⣠⣀⡠⢠⢐⢔⠱⡨⡊⡢⡃⢎⢌⢒⢜⠰⡱⣝⣞⢜⢌⢪⢨⠢⡑⡅⢕⢌⠪⡢⡱⡅
 * ⢮⡳⣝⢮⣫⡳⣕⢗⣗⢽⡹⣝⢮⡳⣝⢮⡣⡊⡪⡘⡌⡪⡂⡯⣺⣪⡳⣝⢞⢮⡺⣜⢮⡢⡱⢨⢊⢢⠱⡨⡊⢆⢕⢑⢌⢪⢸⡺⡼⡱⡐⢕⢔⢑⢕⢘⢌⢆⢷⢝⣝⠆
 * ⡳⣝⢮⣳⡣⡯⡮⣳⢳⡳⣝⢮⡳⣝⢮⡳⡕⢌⠆⡕⢌⢆⠪⣺⢺⢜⣞⢮⢏⣗⣝⢮⡳⣳⢪⠢⡑⡅⢕⠬⡘⢔⢑⢌⠆⡕⡱⣝⢮⢇⢎⢒⢌⠆⡕⡑⡔⡱⣝⢵⢝⡅
 * ⣝⢮⡳⡵⣝⢮⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢎⠢⡣⡊⢆⠕⢅⢗⢽⢕⣗⢽⢕⢧⣳⡳⣝⢮⢯⢎⢎⢌⢆⠣⣊⢪⢨⢂⢇⠪⡪⡮⡯⡪⢢⠱⡰⡑⡌⢆⢕⢘⢮⣫⡳⡅
 * ⢮⡳⡽⣕⢗⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡣⡑⡢⡑⡅⡣⡑⡽⡹⣕⣗⢽⡹⣕⢧⢯⢮⡳⣝⢭⡳⡔⢅⢕⠢⡱⡐⢕⢔⢑⠵⣝⢮⢇⢕⠱⡐⢕⢘⠔⡅⡣⣗⢗⣝⠆
 * ⡳⣝⢞⠮⠷⠽⠵⠽⠮⠷⠽⠮⡳⣝⡮⣳⢕⢸⠨⡢⢱⠨⡢⡫⡯⡺⡼⡵⠽⢪⡳⣝⢞⢞⢮⡳⡽⡹⣆⢕⢑⢌⠪⠂⠎⡢⡹⡪⣯⢪⠢⠱⠡⠣⠡⠣⠪⠸⠼⣕⣗⠅
 * ⣝⢮⣻⣀⣀⣀⣀⣀⣀⢀⢀⢀⣽⠂⠈⠈⠁⠈⠈⢀⢡⢃⠎⡮⡫⡯⡮⡇⢀⢼⢝⠮⡇⢀⡀⢀⡀⢀⢀⠠⡱⡘⡌⡀⠨⡢⢹⢝⢮⡣⡂⡀⡀⡀⡀⡀⡀⡀⢀⣺⢼⠅
 * ⢮⣳⣣⡳⣕⢗⠅⠁⣗⡝⢀⢰⣫⡳⣳⢳⡣⡊⢆⠕⡌⢆⢕⠁⠑⠑⠬⢀⢀⠪⡂⢇⢪⢑⢅⢣⠱⡁⢀⢌⢆⠪⡂⡀⠐⠁⠳⠽⣕⡇⡪⡨⢪⠈⠈⢌⠪⢀⢠⣗⢽⠅
 * ⡳⣕⢧⢯⢮⣻⠁⢀⠁⢀⡰⡯⣺⢺⣪⡳⡽⡸⡐⢕⢅⠣⡊⡢⠢⣀⢀⢀⠐⠑⢅⢣⢑⢌⠆⡕⠁⢀⠐⢕⢌⠪⢌⡀⠠⡠⡠⣀⢀⠈⢆⠕⡅⠅⢀⠁⢀⡄⣗⢗⢽⠅
 * ⢝⢮⡳⣝⡮⠊⢀⣰⢮⡫⣞⣝⢮⣳⡵⣝⣝⣝⣮⣒⢌⢪⠨⡪⡘⢀⢀⢔⢄⢀⢀⡕⢌⠆⠕⠈⢀⡄⢀⠑⢔⠕⢅⡀⠨⡢⢹⡪⡯⡎⢆⢣⠊⢀⡠⢢⠣⢪⡳⡽⡹⠅
 * ⢨⡳⣝⡎⢀⣀⢮⣳⢳⢝⣞⢼⠅⢀⢀⡀⢀⢀⢀⢀⡀⢵⡁⢀⢀⠄⢎⠆⡕⡩⡂⢎⢀⠁⡀⡄⢇⠪⡢⢀⢀⢱⠡⡀⠐⡅⡳⣝⣝⢎⠌⢀⢀⢔⠸⡐⢕⠱⣝⠞⡍
 * ⢀⢺⡺⡲⡳⣝⢵⡳⡽⣕⢗⢽⢝⡽⡽⣝⢽⢽⢽⢽⡹⣕⢗⡞⣆⢇⢕⢑⢌⠆⢎⢪⢐⠕⡌⡊⢆⠣⡊⡆⢆⠕⢅⠢⢌⢆⢳⣣⡳⡕⡱⡘⢔⠅⡕⢅⢣⢑⢅⠣⠂
 * ⢀⢀⠽⡹⣝⢮⡳⣝⢞⢮⡫⣏⣗⣝⢞⢮⡫⣮⡳⡳⣝⢮⡳⣝⢮⡳⣣⢕⡢⡃⡣⡊⡢⡱⡘⡌⡪⠪⡨⡸⡐⢍⢊⢪⠢⡱⢸⣪⡺⡕⢌⠪⡢⢱⢘⠌⡆⢕⠜⠌
 * ⢀⢀⠈⢝⢮⡳⣝⢮⣫⡳⣝⢮⡺⡼⡹⡵⣝⢮⡺⣝⢮⡳⣝⢮⡳⣝⢮⣳⢳⢵⢌⡊⢆⠕⡌⢆⠕⡅⡣⢢⢑⢅⢣⠡⡃⢎⢪⡞⡮⡇⡣⡱⡘⢔⢅⠕⢜⠰⠁
 * ⢀⢀⢀⢀⠑⢝⢮⡳⡵⣝⢮⡳⣝⢮⢏⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⡳⣝⢵⣝⢞⢮⢌⡊⢆⠕⡌⡪⢢⠱⡨⠢⡣⡑⡅⢧⡫⡯⡪⠢⡪⡨⡒⢔⢍⠜
 * ⢀⢀⢀⢀⢀⢀⠑⠹⢺⣪⡳⣝⢮⣫⣫⡳⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⣝⢮⡳⣕⢯⣫⡳⡳⡥⡣⡑⢜⠰⡑⠬⡱⢨⠢⡑⣕⣝⢮⢇⢣⢊⢆⠪⠒⠁
 * ⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠉⠊⠓⠑⠃⠋⠋⠊⠓⠙⠊⠓⠙⠊⠓⠙⠊⠊⠓⠙⠊⠓⠑⠙⠙⠊⠋⠚⠈⠊⠘⠈⠊⠂⠃⠑⠘⠊⠋⠊⠐⠁
 *
 *                © NTT docomo Anime Store inc, All Right Reserved.
 */
(function (window, document, $) {
	"use strict";

	$(function () {
		// 削除されたマイリストを消してアニメーションさせる
		$(window).on("deleteitem.mylist", function (event, $target) {
			$target = $target.closest(".itemModule");
			var checkItemCount = function () {
				var count = parseInt($("#myListName").find(".count").text(), 10) - $target.length;
				count = count < 0 ? 0 : count;
				$("#myListName").find(".count").text(count);

				count = $("#listContainer").find(".itemModule").length;
				$(".btnSelectToggle").find(".count").text(count);
				if ($("#loader:visible").length) {
					// 追加読み込みがある場合は何もしない
				} else if (count === 0) {
					if (pageType !== "SHARE") {
						$(".btnEdit").hide();
						$(".btnEditCancel").click();
					}
					$("#listContainer").html("<p class=\"notfound\">該当作品はありません</p>");
				}
			}
			if (window.COMMON.isLegacySp) {
				// 古いモバイル端末の場合はアニメーションしない
				$target.remove();
				checkItemCount();
				$(window).trigger("scroll");
			} else {
				$target.filter(function (i, el) {
					return $(el).isOnScreen();
				}).transitStop(true, true).transit({
					opacity: 0,
					scale: 0.7,
					delay: 400
				}, {
					duration: 500,
					easing: "out"
				}).queue(function (next) {
					var height = $target.last().offset().top - $target.first().offset().top + $target.height() * 2;
					var $tmp = $target.first().nextAll(".itemModule").not($target).filter(function (i, el) {
						return $(el).isOnScreen(height);
					});

					$tmp.each(function (i, el) {
						var $el = $(el);
						var offset = $el.offset();
						$el.data("pos", [offset.left, offset.top]);
					});

					$target.remove();

					var getOffsetX = function (el) {
						return el.offsetLeft - parseInt(el.style.left || 0, 10);
					};
					var getOffsetY = function (el) {
						return el.offsetTop - parseInt(el.style.top || 0, 10);
					};
					$tmp.each(function (i, el) {
						el.style.willChange = "transform";
						var $el = $(el);
						var beforePos = $el.data("pos");
						var moveX = beforePos[0] - getOffsetX(el);
						var moveY = beforePos[1] - getOffsetY(el);
						$el.removeData("pos");
						$el.transitStop(true).transit({x: moveX + "px", y: moveY + "px"}, {duration: 0}).transit({x: 0, y: 0}, {duration: 500, complete: function () {
							el.removeAttribute("style");
						}});
					});
					checkItemCount();

					next();
					$(window).trigger("scroll");
				});
			}
		});
	});

	var PAGE_TYPE_MAP = {
		"/animestore/mpa_rsv": "MYLIST",
		"/animestore/mpa_rsv_pc": "MYLIST",
		"/animestore/mpa_shr": "SHARE",
		"/animestore/mpa_shr_pc": "SHARE",
		"/animestore/public_list": "PUBLIC"
	};

	var API_MAP = {
		"MYLIST": window.COMMON.RESTAPI_ENDPOINT.getMyList,
		"SHARE": window.COMMON.RESTAPI_ENDPOINT.getWorkFromShareList,
		"PUBLIC": window.COMMON.RESTAPI_ENDPOINT.getPublicList
	};

	var pageType = window.pageType || PAGE_TYPE_MAP[window.location.pathname] || "";

	var LENGTH = (pageType === "SHARE" || pageType === "PUBLIC") ? 50 : 20;

	var createUrlFunc = function (param) {
		var url = window.getApiUrl || API_MAP[pageType] || "" || window.COMMON.RESTAPI_ENDPOINT.getMyList;
		var array = [];
		param = param || {};
		var start = param.start;
		var length = param.length;
		var shareListId = param.shareListId;

		if (start) { array.push("start=" + start); }
		if (length) { array.push("length=" + length); }
		if (shareListId) { array.push("shareListId=" + shareListId); }

		if (array.length) {
			var search = "";
			$.each(array, function (index, val) {
				if (search) {
					search += "&";
				}
				search += val;
			});
			url += ((url.indexOf("?") === -1) ? "?" : "&") + search;
		}
		return url;
	};

	var optionPattern = {
		// "new": "NEW",
		"limitedTime": "配信期間あり",
		"hd": "HD対応",
		"free": "無料話あり",
		"endsSoon": "まもなく終了",
		"music": "アニソン",
		"r15": "R15+"
	};
	var iconPattern = {
		"complete": "iconTextComplete"
	};
	var createDomFunc = function (list) {
		var dom = "";
		var e = window.COMMON.escape;
		var loading = window.COMMON.IMAGE_URL.loading;
		var nothing = window.COMMON.IMAGE_URL.nothing;
		$.each(list, function (index, val) {
			var workInfo = val.workInfo;
			var userInfo = val.userInfo;
			var rankingInfo = val.rankingInfo;
			var workIcons = (workInfo && workInfo.workIcons instanceof Array) ? workInfo.workIcons : [];
			var memberFlags = (userInfo && userInfo.memberFlags instanceof Array) ? userInfo.memberFlags : [];
			var ageLimitType = "";

			if (workInfo && workInfo.completeFlag === "1") {
				memberFlags.push("complete");
			}

			if (workInfo && workInfo.workTypeList instanceof Array && workInfo.workTypeList.indexOf("music") !== -1) {
				workIcons.push("music");
			}
			if (workInfo.ageLimitType === "2") {
				workIcons.push("r15");
			}

			dom += "<div class=\"itemModule list" + (pageType === "SHARE" ? " mybest" : "") + "\" data-workId=\"" + val.workId + "\">";
			dom +=	"<section>";
			dom +=		"<a href=\"" + workInfo.link + "\" class=\"itemModuleIn\">";
			dom +=			"<div class=\"thumbnailContainer\">";
			dom +=				"<div class=\"imgWrap16x9\"><img class=\"lazyload\" src=\"" + loading + "\"";
			dom +=						" data-src=\"" + workInfo.mainKeyVisualPath + "\" width=\"640\" height=\"360\" alt=\"" + e(workInfo.mainKeyVisualAlt) + "\"></div>";
			dom +=			"</div>";
			dom +=			"<div class=\"textContainer\">";
			dom +=				"<div class=\"textContainerIn\">";
			dom +=					"<h3 class=\"line2\"><span>" + e(workInfo.workTitle) + "</span></h3>";
			dom +=				"</div>";
			dom +=				"<ul class=\"iconContainer\">";
			$.each(memberFlags, function (i, v) {
				var clazz = iconPattern[v];
				if (clazz) {
					dom +=			"<li><i class=\"icon " + clazz + "\"></i></li>";
				}
			});
			dom +=				"</ul>";
			dom +=			"</div>";
			dom +=		"</a>";
			if (val.workId.indexOf("C") !== 0 && pageType !== "PUBLIC") {
				dom +=	"<div class=\"addMyList edit\" data-workid=\"" + val.workId + "\">";
				dom +=		"<input type=\"checkbox\"" + ((memberFlags.indexOf("share") !== -1) ? " checked=\"checked\"" : "") + "><label>編集</label>";
				dom +=	"</div>";
			}
			dom +=		"<ul class=\"option\">";
			$.each(workIcons, function (i, v) {
				var text = optionPattern[v];
				if (text) {
					dom +=	"<li>" + text + "</li>";
				}
			});
			dom +=		"</ul>";
			dom +=	"</section>";
			if (pageType !== "PUBLIC") {
				dom += "<div class=\"selectedImg\">" + (pageType === "SHARE" ? "削除" : "") + "</div>";
				if (pageType === "SHARE") {
					dom += "<div class=\"sortBtnArea onlyLegacySp\"><div class=\"btnSort btnSortUp\">上へ</div><div class=\"btnSort btnSortDown\">下へ</div></div>";
					dom += "<div class=\"dragBtnArea notLegacySp\"><div class=\"btnDrag\"></div></div>";
				}
			}
			dom += "</div>";
		});
		return dom || "<p class=\"notfound\">該当作品はありません</p>";
	};

	///////////////////////////////////////////////////
	// documentタイトルの設定
	///////////////////////////////////////////////////
	var defaultTitle = document.title;
	var setTitle = function (length) {
		var consonantKey = $("#characterSelect").find("[selected]").text() || "";
		var title = defaultTitle.split("|");
		// title[0] += "[" + ((consonantKey) ? consonantKey + " " : "") + "1～" + length + "] ";
		if (consonantKey) { title[0] +=  "[" + consonantKey + "] "; }
		title = title.join("|");
		if (document.title !== title) {
			document.title = title;
		}
	};

	///////////////////////////////////////////////////
	// URLの状態から表示情報を取得する
	///////////////////////////////////////////////////
	var analyzeState = function () {
		return $.extend({length: LENGTH}, window.COMMON.getSearch(), window.COMMON.getHash(), window.COMMON.getState());
	};

	///////////////////////////////////////////////////
	// 追加読み込み処理の付加
	///////////////////////////////////////////////////
	var setAutoLoadFunc = function () {
		var callee = function () {
			$("#loader").removeClass("reload");
			var param = analyzeState();
			param.start = $("#listContainer").find(".itemModule").length;
			param.length = LENGTH;
			var url = createUrlFunc(param);
			if (url) {
				window.COMMON.restGet(url).done(function (data) {
					data = data || {workList: [], count: 0, maxCount: 0};
					$("#listContainer").append(createDomFunc(data.workList));
					$(window).trigger("appenditem.mylist"); // イベント付加などが必要なため追加されたことを通知
					param = analyzeState();
					var len = parseInt(param.length, 10) + LENGTH;
					setTitle(len);

					var args = {"length": len};
					window.COMMON.addState(args);

					if (Math.ceil((len + data.count) / LENGTH) <= Math.ceil(data.maxCount / LENGTH)) {
						$("#loader").show();
						setAutoLoadFunc();
					} else {
						$("#loader").hide();
					}
					var count = $("#listContainer").find(".itemModule").length;
					$(".btnSelectToggle").find(".count").text(count);
					$(".btnEdit")[count === 0 && pageType !== "SHARE" ? "hide" : "show"]();
				}).fail(function (errorCode) {
					window.COMMON.showToast("データの取得に失敗しました");
					$("html,body").animate({
						scrollTop: $("#loader").offset().top - $(window).height() // ローダーが見えない位置までスクロールを戻す
					}, {
						"complete": function () {
							$("#loader").checkOnScreen("onscreen").off("onscreen").one("onscreen", callee);
						}
					});
				});
			}
		};
		$("#loader").checkOnScreen("onscreen").off("onscreen").one("onscreen", callee);
	};

	///////////////////////////////////////////////////
	// 初回処理
	///////////////////////////////////////////////////
	var firstloadFunc = function () {
		var param = analyzeState();
		var deferredList = [];
		for (var length = param.length, start = 0; length > 0; length -= 300, start += 300) {
			var len = length;
			if (len > 300) {
				len = 300;
			}
			var url = createUrlFunc($.extend({}, param, {length: len, start: start}));
			deferredList.push(window.COMMON.restGet(url));
		}
		$.when.apply(this, deferredList).done(function () {
			var data = {
				count: 0,
				maxCount: 0,
				shareListName: "",
				workList: []
			};
			$.each(arguments, function(index, val) {
				data.count += val.count || 0;
				data.maxCount = val.maxCount;
				data.shareListName = val.shareListName;
				Array.prototype.push.apply(data.workList, val.workList || []);
			});
			$(function () { // 初回はDomContentLoadedまで待つ
				$("#listContainer").html(createDomFunc(data.workList));
				$(window).trigger("appenditem.mylist"); // イベント付加などが必要なため追加されたことを通知
				param = analyzeState();
				if (data.shareListName && data.shareListName.length) {
					$("#myListName").find(".text").text(data.shareListName);
					$("#editMyListName").attr("value", data.shareListName);
				}
				$("#myListName").find(".count").text(data.maxCount).end().addClass("visible");
				$(".btnSelectToggle").find(".count").text(data.count);
				$(".btnEdit")[data.count === 0 && pageType !== "SHARE" ? "hide" : "show"]();
				var $loader = $("#loader");
				if ($loader.length) {
					var args = {"length": param.length};
					window.COMMON.addState(args);

					if (Math.ceil((LENGTH + data.count) / LENGTH) <= Math.ceil(data.maxCount / LENGTH)) {
						$loader.show();
						setAutoLoadFunc();
					} else {
						$loader.hide();
					}
				}
				setTitle(param.length);
				$(window).trigger("pageshow");
			});
		}).fail(function (errorCode) {
			$(function () { // 初回はDomContentLoadedまで待つ
				window.COMMON.showDialog({
					title: "確認",
					text: "データの取得に失敗しました。再度データを読み込んで表示しますか？",
					button1Text: "キャンセル",
					button2Text: "再読み込み",
					button2Callback: firstloadFunc
				});
			});
		});
	};
	firstloadFunc();

})(this, this.document, this.jQuery);

