/*!
 * ⢀⢀⢀⢀⢀⢀⢀⢀⣄⣔⣔⣗⣝⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⢾⢀⢀⢀⢀⢀⢀⢀⠰⡘⡔⢜⠔⢜⠌⡆⢔⢀⠄
 * ⢀⢀⢀⢀⢀⣀⢮⢯⣺⣪⡺⣜⢮⢮⡳⣕⡗⣗⢗⣳⢳⡳⡳⣓⡗⣗⢗⣳⢳⡳⡳⣓⡗⡗⡹⢨⠂⢀⢀⢀⢀⢀⢀⢨⡪⡨⠢⡣⡑⡱⢨⠢⢣⠱⡨⡂⡀
 * ⢀⢀⢀⠠⡲⣝⣕⣗⢵⢵⢝⢮⡳⡳⣝⢮⡺⡮⣳⢳⡳⣝⣝⢞⢞⢮⡳⣳⢳⢝⢝⠪⡊⡢⡊⡲⢀⢀⢀⢀⢀⢀⢀⢸⢽⡹⡵⣌⡪⡨⢢⠣⡑⢕⢌⢮⢮⡢
 * ⢀⢀⡠⡯⣫⣺⡪⡮⡳⣝⢽⢵⢝⣝⢮⡳⣝⢞⢮⡳⣝⢮⢮⡫⣏⢗⣝⠮⡋⡪⡘⡌⡪⠢⡱⡘⠄⢀⢀⢀⢀⢀⢀⢸⡳⣝⣝⢮⣺⣪⡢⠣⡑⡱⡬⣳⢳⢝⣖⢀
 * ⢀⣘⢮⢯⡺⣪⢮⢏⢯⢮⡳⣝⣕⡗⣗⣝⢮⣫⡳⣝⢮⡳⡳⣝⠮⡫⡘⡌⡊⡆⢕⢌⢪⢸⡰⣽⠁⢀⢀⢀⢀⢀⢀⢸⢘⢺⢼⢕⡗⣮⡺⣝⢮⡫⣞⢮⢫⢑⠕⢍
 * ⢠⣪⣳⢳⢝⢮⡳⡽⡹⡵⣝⢞⣜⡞⣞⢮⡳⡵⣝⢮⡳⡝⡝⢌⠪⢢⢑⢌⢪⠨⡢⡱⣎⣗⣝⢾⢀⢀⢀⢀⢀⢀⢀⢰⢑⢜⢮⡳⣝⢮⡺⡮⡳⣝⢮⡪⡢⡑⡅⡣⢡
 * ⣔⢧⡳⡽⡹⡵⣝⢽⡹⡵⣝⣕⣗⣝⢮⡳⣝⢞⢮⢳⢑⢕⢘⢌⠪⡊⠢⠑⠘⠈⠊⠋⠚⠪⠮⣻⠄⢀⢀⢀⢀⢀⢀⢰⣕⢗⣗⣝⢮⡳⣝⢮⡻⣪⡳⡽⣕⢧⡪⡘⠔⠄
 * ⢮⡳⣝⢮⢏⢯⢮⡳⣝⢞⢮⡺⣜⢮⡳⣝⢮⡫⡯⣆⠣⡂⡇⠊⠈⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠈⢀⢀⢀⢀⢀⢀⢀⣸⢮⡳⣕⢗⣗⣝⠮⡳⢹⠪⢯⡺⣪⡳⣝⢵⣕⠅
 * ⡳⣝⢮⡫⣏⢯⣺⢺⡪⡯⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡳⠅⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡘⢧⡻⣪⡳⡵⡡⡃⢎⠢⢍⢆⢛⢮⡫⡮⡳⣕⠇
 * ⣝⢮⡳⣝⢮⡳⣕⢷⢝⢽⣹⣪⡳⣝⢮⡳⡝⢌⢍⠗⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠸⡐⢍⢺⡪⡯⡦⡣⡑⢕⢑⢌⢮⡳⣝⢽⡹⡪⡁
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⢗⢵⢵⢝⢮⡳⣝⢎⢊⢆⠁⢀⢀⢀⢀⢀⢀⢀⢀⡠⠠⡄⡄⢄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢱⡱⣕⢷⢝⢮⡫⡮⡯⡳⡽⡹⡵⣝⠮⡣⠣⡑⠄
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢮⢏⢯⢮⢏⢷⢝⢮⡣⢱⢀⢀⢀⢀⢀⢀⢀⢀⡴⡫⣮⡳⣌⡪⡂⢇⢆⢀⢀⢀⢀⢀⢀⢀⢀⢼⢝⢮⡳⣝⢗⢽⣹⡪⣏⢯⡫⣋⢪⢘⢌⢪⠸⡀
 * ⣝⢮⡳⣝⢮⡳⣝⢮⡳⡽⣝⢮⣫⡳⡽⣕⢇⠕⢀⢀⢀⢀⢀⢀⢀⡸⠨⡫⢺⡺⣺⡪⡮⡢⡅⣃⢀⢀⢀⢀⢀⢀⢀⢸⢹⡳⣝⢮⣫⡳⡵⣝⢎⢇⠪⠢⡑⡌⢆⢕⢑⠄
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⡞⡮⡳⡵⣝⢞⢮⡣⡃⢀⢀⢀⢀⢀⢀⢐⠸⡨⡊⡢⡱⠱⣝⢮⢯⡳⣲⢀⢀⢀⢀⢀⢀⢀⠸⡐⡜⢜⢓⢕⠝⡍⡢⢱⢐⢍⢪⢘⠌⡆⣕⢼⠅
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡫⡯⡺⡮⣫⡳⡕⡂⢀⢀⢀⢀⢀⢀⢀⢇⢪⠨⡒⡌⢕⠔⢍⢺⢺⣺⠁⢀⢀⢀⢀⢀⢀⢡⢃⢎⢢⠱⡨⡊⡢⡑⢕⠌⡆⢕⢬⡺⣺⡪⡯⡃
 * ⣝⢮⡳⣝⢮⡳⣝⢮⣫⡳⣝⢮⡻⣪⡳⣝⢎⢌⢀⢀⢀⢀⢀⢀⢀⢱⠡⡱⡨⡊⢆⠣⠣⡑⡔⢍⢀⢀⢀⢀⢀⢀⢀⠌⡆⡪⠢⡱⢨⢊⢢⢑⢅⢕⢼⣪⡳⣝⢮⠺⡩⠂
 * ⢮⡳⣝⢮⡳⣝⢮⣳⡣⡯⡮⡳⣝⢮⡫⣮⢣⠪⡀⢀⢀⢀⢀⢀⢀⢀⠣⡊⡢⢪⢘⢌⢕⢑⠜⢀⢀⢀⢀⢀⢀⢀⢀⢸⢦⣑⢕⠸⡐⡅⣕⣜⢮⢯⡳⡳⡝⡪⠪⡘⡌⡂
 * ⡳⣝⢮⡳⣝⢮⡳⡵⣝⢮⡫⡯⡮⡳⣝⢮⡣⡑⡅⡀⢀⢀⢀⢀⢀⢀⢀⠈⠘⠐⠕⠌⠂⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢼⡳⣓⣗⣝⢮⣫⡺⡼⣕⢗⠝⡌⢆⢕⢑⠕⢌⠂
 * ⣝⢮⡳⣝⢮⡳⡽⣕⢗⣗⣝⢮⡫⡯⡮⣳⢕⠌⡆⠥⡀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢘⢝⢮⡺⡼⣕⢗⣝⠞⡌⢆⠣⡊⡆⠕⡅⢕⡑⠅
 * ⢮⡳⣝⢮⡳⣝⡞⡮⡳⣕⢗⣗⣝⢮⢯⢮⡣⢱⢘⢌⠆⡄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⠢⣑⠱⡐⡕⣝⣞⢮⣳⠱⡑⠜⡌⡪⢌⢪⢘⢌⠆⢎⠂
 * ⡳⣝⢮⡳⣝⢞⢮⡫⡯⡮⡳⣕⣗⣝⢮⡳⡕⡑⡌⢆⠕⡜⠔⣄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⡐⢕⠸⡨⡂⡣⡱⢨⢺⢜⣕⡇⡕⠬⡱⢨⢊⢢⠱⡨⡂⢇⢕⠁
 * ⣝⢮⡳⣝⢮⢏⣗⣝⢮⡫⡯⡺⣜⢮⡳⣝⢎⢌⠪⡂⢇⠪⡊⡮⣻⡲⡦⡤⣠⣀⣠⣀⡠⢠⢐⢔⠱⡨⡊⡢⡃⢎⢌⢒⢜⠰⡱⣝⣞⢜⢌⢪⢨⠢⡑⡅⢕⢌⠪⡢⡱⡅
 * ⢮⡳⣝⢮⣫⡳⣕⢗⣗⢽⡹⣝⢮⡳⣝⢮⡣⡊⡪⡘⡌⡪⡂⡯⣺⣪⡳⣝⢞⢮⡺⣜⢮⡢⡱⢨⢊⢢⠱⡨⡊⢆⢕⢑⢌⢪⢸⡺⡼⡱⡐⢕⢔⢑⢕⢘⢌⢆⢷⢝⣝⠆
 * ⡳⣝⢮⣳⡣⡯⡮⣳⢳⡳⣝⢮⡳⣝⢮⡳⡕⢌⠆⡕⢌⢆⠪⣺⢺⢜⣞⢮⢏⣗⣝⢮⡳⣳⢪⠢⡑⡅⢕⠬⡘⢔⢑⢌⠆⡕⡱⣝⢮⢇⢎⢒⢌⠆⡕⡑⡔⡱⣝⢵⢝⡅
 * ⣝⢮⡳⡵⣝⢮⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢎⠢⡣⡊⢆⠕⢅⢗⢽⢕⣗⢽⢕⢧⣳⡳⣝⢮⢯⢎⢎⢌⢆⠣⣊⢪⢨⢂⢇⠪⡪⡮⡯⡪⢢⠱⡰⡑⡌⢆⢕⢘⢮⣫⡳⡅
 * ⢮⡳⡽⣕⢗⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡣⡑⡢⡑⡅⡣⡑⡽⡹⣕⣗⢽⡹⣕⢧⢯⢮⡳⣝⢭⡳⡔⢅⢕⠢⡱⡐⢕⢔⢑⠵⣝⢮⢇⢕⠱⡐⢕⢘⠔⡅⡣⣗⢗⣝⠆
 * ⡳⣝⢞⠮⠷⠽⠵⠽⠮⠷⠽⠮⡳⣝⡮⣳⢕⢸⠨⡢⢱⠨⡢⡫⡯⡺⡼⡵⠽⢪⡳⣝⢞⢞⢮⡳⡽⡹⣆⢕⢑⢌⠪⠂⠎⡢⡹⡪⣯⢪⠢⠱⠡⠣⠡⠣⠪⠸⠼⣕⣗⠅
 * ⣝⢮⣻⣀⣀⣀⣀⣀⣀⢀⢀⢀⣽⠂⠈⠈⠁⠈⠈⢀⢡⢃⠎⡮⡫⡯⡮⡇⢀⢼⢝⠮⡇⢀⡀⢀⡀⢀⢀⠠⡱⡘⡌⡀⠨⡢⢹⢝⢮⡣⡂⡀⡀⡀⡀⡀⡀⡀⢀⣺⢼⠅
 * ⢮⣳⣣⡳⣕⢗⠅⠁⣗⡝⢀⢰⣫⡳⣳⢳⡣⡊⢆⠕⡌⢆⢕⠁⠑⠑⠬⢀⢀⠪⡂⢇⢪⢑⢅⢣⠱⡁⢀⢌⢆⠪⡂⡀⠐⠁⠳⠽⣕⡇⡪⡨⢪⠈⠈⢌⠪⢀⢠⣗⢽⠅
 * ⡳⣕⢧⢯⢮⣻⠁⢀⠁⢀⡰⡯⣺⢺⣪⡳⡽⡸⡐⢕⢅⠣⡊⡢⠢⣀⢀⢀⠐⠑⢅⢣⢑⢌⠆⡕⠁⢀⠐⢕⢌⠪⢌⡀⠠⡠⡠⣀⢀⠈⢆⠕⡅⠅⢀⠁⢀⡄⣗⢗⢽⠅
 * ⢝⢮⡳⣝⡮⠊⢀⣰⢮⡫⣞⣝⢮⣳⡵⣝⣝⣝⣮⣒⢌⢪⠨⡪⡘⢀⢀⢔⢄⢀⢀⡕⢌⠆⠕⠈⢀⡄⢀⠑⢔⠕⢅⡀⠨⡢⢹⡪⡯⡎⢆⢣⠊⢀⡠⢢⠣⢪⡳⡽⡹⠅
 * ⢨⡳⣝⡎⢀⣀⢮⣳⢳⢝⣞⢼⠅⢀⢀⡀⢀⢀⢀⢀⡀⢵⡁⢀⢀⠄⢎⠆⡕⡩⡂⢎⢀⠁⡀⡄⢇⠪⡢⢀⢀⢱⠡⡀⠐⡅⡳⣝⣝⢎⠌⢀⢀⢔⠸⡐⢕⠱⣝⠞⡍
 * ⢀⢺⡺⡲⡳⣝⢵⡳⡽⣕⢗⢽⢝⡽⡽⣝⢽⢽⢽⢽⡹⣕⢗⡞⣆⢇⢕⢑⢌⠆⢎⢪⢐⠕⡌⡊⢆⠣⡊⡆⢆⠕⢅⠢⢌⢆⢳⣣⡳⡕⡱⡘⢔⠅⡕⢅⢣⢑⢅⠣⠂
 * ⢀⢀⠽⡹⣝⢮⡳⣝⢞⢮⡫⣏⣗⣝⢞⢮⡫⣮⡳⡳⣝⢮⡳⣝⢮⡳⣣⢕⡢⡃⡣⡊⡢⡱⡘⡌⡪⠪⡨⡸⡐⢍⢊⢪⠢⡱⢸⣪⡺⡕⢌⠪⡢⢱⢘⠌⡆⢕⠜⠌
 * ⢀⢀⠈⢝⢮⡳⣝⢮⣫⡳⣝⢮⡺⡼⡹⡵⣝⢮⡺⣝⢮⡳⣝⢮⡳⣝⢮⣳⢳⢵⢌⡊⢆⠕⡌⢆⠕⡅⡣⢢⢑⢅⢣⠡⡃⢎⢪⡞⡮⡇⡣⡱⡘⢔⢅⠕⢜⠰⠁
 * ⢀⢀⢀⢀⠑⢝⢮⡳⡵⣝⢮⡳⣝⢮⢏⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⡳⣝⢵⣝⢞⢮⢌⡊⢆⠕⡌⡪⢢⠱⡨⠢⡣⡑⡅⢧⡫⡯⡪⠢⡪⡨⡒⢔⢍⠜
 * ⢀⢀⢀⢀⢀⢀⠑⠹⢺⣪⡳⣝⢮⣫⣫⡳⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⣝⢮⡳⣕⢯⣫⡳⡳⡥⡣⡑⢜⠰⡑⠬⡱⢨⠢⡑⣕⣝⢮⢇⢣⢊⢆⠪⠒⠁
 * ⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠉⠊⠓⠑⠃⠋⠋⠊⠓⠙⠊⠓⠙⠊⠓⠙⠊⠊⠓⠙⠊⠓⠑⠙⠙⠊⠋⠚⠈⠊⠘⠈⠊⠂⠃⠑⠘⠊⠋⠊⠐⠁
 *
 *                © NTT docomo Anime Store inc, All Right Reserved.
 */
(function (window, document, $) {
	"use strict";

	var selectAll = function (boolean) {
		var $body = $("body");
		if (boolean) {
			$(".contentsWrapper:not(.dmarketWrapper)").find(".itemModule").removeClass("notSelected").addClass("selected");
		} else {
			$(".contentsWrapper:not(.dmarketWrapper)").find(".itemModule").addClass("notSelected").removeClass("selected");
		}
	};
	var setSelectMode = function (boolean) {
		if (boolean) {
			$("body").addClass("selectAll");
			$(".btnSelectToggle").addClass("checked").find("input[type='checkbox']").prop("checked", true);
		} else {
			$("body").removeClass("selectAll");
			$(".btnSelectToggle").removeClass("checked").find("input[type='checkbox']").prop("checked", false);
		}
	};
	var updateDeleteCount = function () {
		$(".btnDelete").find(".count").text($(".contentsWrapper:not(.dmarketWrapper)").find(".itemModule.selected").not(".add").not(".delete").length);
	};
	function handleTouchMove(event) {
		event.preventDefault();
		event.stopPropagation();
	}

	//エディットモード終了
	var closeEditMode = function () {
		$("body").removeClass("editMode");
		var $contentRoot = $(".contentsWrapper:not(.dmarketWrapper)");

		$contentRoot.find(".itemModule").removeClass("edit").removeClass("notSelected").removeClass("selected").removeAttr("data-sort-index");
		$(".mypageHeader.mybest").removeClass("edit");
		$contentRoot.find(".itemModule, .btnSelectToggle, .itemModule .btnSort").off("click");
		$contentRoot.find(".itemModule.mybest").off(".editmode");
		$(window).off(".editmode");
		$(".editFooter").find(".btnCancel, .btnDelete").add(".btnEditCancel").off("click");

		// editModeFlag(クエリパラメータ)とセットで利用する表示制御用Cookie削除
		window.COMMON.deleteCookie("edit_mode_show_control");

		setSelectMode(false);

	};


	// 編集するクリック時
	$.setEditMode = function () {
		updateDeleteCount();

		$("body").addClass("editMode");
		var $contentRoot = $(".contentsWrapper:not(.dmarketWrapper)");

		var $editFooter = $(".editFooter");
		var $mybestHeader = $(".mypageHeader.mybest");
		if ($mybestHeader.length) {
			$mybestHeader.addClass("edit");
		}
		$().transitionStop(); // jquery.transit.min.jsを事前に読み込むために空実行

		var setItemModuleEvent = function () {
			setSelectMode(false);
			var $itemModule = $contentRoot.find(".itemModule");
			$itemModule.each(function(index, el) {
				var $el = $(el);
				if (!$el.hasClass("edit")) {
					$el.attr("data-sort-index", index).addClass($("body").hasClass("selectAll") ? "selected" : "notSelected");
				}
			});
			$itemModule = $itemModule.filter(":not(.edit)").addClass("edit");

			if ($mybestHeader.length && !window.COMMON.isLegacySp) {
				var _ = window.COMMON.pointerEvent;
				var normalizeEvent = function (e) {
					var event = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches.length ? e.originalEvent.touches[0] : e;
					e.clientX = e.clientX || event.clientX;
					e.clientY = e.clientY || event.clientY;
					e.pageX = e.pageX || event.pageX;
					e.pageY = e.pageY || event.pageY;
					e.screenX = e.screenX || event.screenX;
					e.screenY = e.screenY || event.screenY;
				};
				var copyEvent = function (e) {
					return $.Event(e.type, e);
				};
				var requestAnimationFrame =
						// window.requestAnimationFrame ||
						// window.webkitRequestAnimationFrame ||
						// window.mozRequestAnimationFrame ||
						window.setTimeout;
				var cancelAnimationFrame =
						// window.cancelAnimationFrame ||
						// window.mozCancelAnimationFrame ||
						window.clearTimeout;

				// ドラッグ時
				$itemModule.filter(".mybest").on(_.addLabel(_.addMouseEventName(_.start), ".editmode"), function (event) {
					normalizeEvent(event);
					var $list = $(event.target).closest(".itemModule");
					if ($list.data("isTouch") === true) {
						return;
					}
					$list.data("isTouch", true);
					var basePos = [event.pageX, event.pageY];
					var listEl = $list[0];
					var listWidth = $list.outerWidth();
					var listHeight = $list.outerHeight();
					var windowHeight = window.innerHeight;
					var documentHeight = $(document).height();
					var editFooterHeight = $editFooter.height();
					var SCROLL_DISTANCE = 15;
					var SCROLL_INTERVAL = 30;
					var THROTTLE_INTERVAL = 20;
					var THRESHOLD = 80;
					var THRESHOLD_BOTTOM = windowHeight - editFooterHeight - THRESHOLD;
					var SWAP_ANIME_DURATION = 500;
					var lastEventTimestamp = null;
					var intervalTimerId = null;
					var NOANIME_PARAMS = {duration: 0};
					var centerPointList = [];
					var scrollTmp = window.scrollY || window.pageYOffset;
					var distanceCheck = false;
					$list.data("isMove", false);
					var scrollFunc = function (diff, direction, rate) {
						var scrollY = window.scrollY || window.pageYOffset;
						var isLimit = direction === "up" ? (scrollY > SCROLL_DISTANCE) : (documentHeight - windowHeight - scrollY > SCROLL_DISTANCE);
						var distance = 0;
						if (isLimit) {
							distance = (SCROLL_DISTANCE + Math.floor(Math.log(Math.pow(diff, 2)))) * (direction === "up" ? 1 : -1);
							distance = Math.floor(distance * (rate || 1));
							window.scrollTo(0, scrollY - distance);
						}
						return distance;
					};
					var getOffsetX = function (el) {
						return el.offsetLeft - parseInt(el.style.left || 0, 10);
					};
					var getOffsetY = function (el) {
						return el.offsetTop - parseInt(el.style.top || 0, 10);
					};

					var initPointList = function () {
						centerPointList.splice(0, centerPointList.length);
						$contentRoot.find(".itemModule").each(function (index, el) {
							var pos = $(el).data("index", index).offset();
							centerPointList.push([pos.left + listWidth / 2, pos.top + listHeight / 2, index]);
						});
					};
					$(window).on("appenditem.mylist.editmode", function () {
						windowHeight = window.innerHeight;
						documentHeight = $(document).height();
						initPointList();
					});
					initPointList();

					$(window).on(_.addLabel(_.addMouseEventName(_.move), ".drag.editmode"), function (event) {
						// iosで並び替えできない不具合の解消
						if (window.COMMON.naviDevice1 == "3") {
							window.addEventListener('touchmove', handleTouchMove, { passive: false });
						}
						if (event.originalEvent && event.originalEvent.movementX === 0 && event.originalEvent.movementY === 0) {
							// マウスが実際に移動していない場合は処理しない
							return;
						}
						normalizeEvent(event);
						var moveX = event.pageX - basePos[0];
						var moveY = event.pageY - basePos[1];
						if (moveX === 0 && moveY === 0) {
							// マウスが実際に移動していない場合は処理しない
							return;
						}
						$list.addClass("drag");
						// イベント処理を間引く処理
						/* */var now = Date.now();
						// スクロール処理ではない(ドラッグ処理)、かつイベント間隔が短い場合
						if (!event.isTrigger && lastEventTimestamp && now - lastEventTimestamp < THROTTLE_INTERVAL) {
							// スクロールタイマーが発行されている場合、一旦解除し、
							// ドラッグの際のマウス座標をコピーして再度スクロールタイマーを発行する
							if (intervalTimerId) {
								var ev = copyEvent(event);
								cancelAnimationFrame(intervalTimerId);
								intervalTimerId = requestAnimationFrame(function () {
									intervalTimerId = null;
									$(window).trigger(ev);
								}, SCROLL_INTERVAL);
							}
							return false;
						}
						lastEventTimestamp = now;
						// イベント処理を間引く処理ここまで

						// スクロール処理ではない場合(ドラッグ処理の場合)は、スクロールタイマーを解除する(あとで再発行される)
						if (!event.isTrigger) {
							cancelAnimationFrame(intervalTimerId);
							intervalTimerId = null;
						}
						// スクロール処理ではない場合(ドラッグ処理の場合)は、スクロールタイマーを解除する(あとで再発行される)ここまで

						$list.data("isMove", true);

						// 画面上下にドラッグした場合にスクロール追従させる
						var distance = 0;
						if (event.clientY < THRESHOLD || event.clientY > THRESHOLD_BOTTOM) {
							cancelAnimationFrame(intervalTimerId); intervalTimerId = null;
							distance = event.clientY < THRESHOLD ? scrollFunc(THRESHOLD - event.clientY, "up", event.rate) : scrollFunc(event.clientY - THRESHOLD_BOTTOM, "down", event.rate);
							event.pageY -= distance;
							distanceCheck = true;
						} else {
							cancelAnimationFrame(intervalTimerId); intervalTimerId = null;
						}
						// 画面上下にドラッグした場合にスクロール追従させるここまで

						// マウスカーソルにドラッグ中要素を追従させる
						if (window.COMMON.naviDevice1 == "3") {
							if (scrollTmp == (window.scrollY || window.pageYOffset) || distanceCheck) {
								$list.transitStop(true).transit({x: moveX + "px", y: moveY + "px"}, NOANIME_PARAMS);
							}
							else {
								clearInterval(intervalTimerId);
								$list.transitStop(true).transit({x: 0, y: 0, scale: 1}, {duration: 0, complete: function () {
									listEl.removeAttribute("style");
									$list.removeClass("drag");
								}});
								window.removeEventListener('touchmove', handleTouchMove, { passive: false });
								$(window).off(".drag.editmode appenditem.mylist.editmode");
								$list.removeData("isTouch");
								return false;
							}
						}
						else {
							$list.transitStop(true).transit({x: moveX + "px", y: moveY + "px"}, NOANIME_PARAMS);
						}
						// マウスカーソルにドラッグ中要素を追従させるここまで

						// ドラッグ中要素に重なっている要素を算出
						var centerPos = centerPointList[$list.data("index")];
						var centerX = centerPos[0] + moveX;
						var centerY = centerPos[1] + moveY;
						var list = $.grep(centerPointList, function (val) {
							return Math.abs(centerY - val[1]) < listHeight && Math.abs(centerX - val[0]) < listWidth;
						});
						// ドラッグ中要素に重なっている要素を算出ここまで

						// ドラッグ中要素に重なっている要素から一番近い要素を算出
						var target = null;
						$.each(list, function (index, val) {
							if (target) {
								var minDistance = target[target.length - 1];
								var distance = Math.pow(centerX - val[0], 2) + Math.pow(centerY - val[1], 2);
								if (minDistance > distance) {
									target = [val, distance];
								}
							} else {
								target = [val, Math.pow(centerX - val[0], 2) + Math.pow(centerY - val[1], 2)];
							}
						});
						// ドラッグ中要素に重なっている要素から一番近い要素を算出ここまで

						if (target) {
							var $allList = $contentRoot.find(".itemModule");
							var targetIndex = target[0][2];
							var $target = $allList.eq(targetIndex);
							var targetEl = $target[0];
							var listIndex = $allList.index($list);
							if (!$target.is($list)) {
								// 移動が必要な要素の座標を、要素入れ替え前に保存しておく
								var $tmp = listIndex > targetIndex ? $allList.slice(targetIndex, listIndex) : $($allList.slice(listIndex + 1, targetIndex + 1).get().reverse());
								$tmp.each(function (i, el) {
									var $el = $(el);
									$el.data("index", $el.data("index") + (listIndex > targetIndex ? 1 : -1));
									var offset = $el.offset();
									$el.data("pos", [offset.left, offset.top]);
								});
								// 移動が必要な要素の座標を、要素入れ替え前に保存しておくここまで

								// 要素を入れ替えるとドラッグ基準点がずれるので、予め入れ替えた先の座標を元にドラッグ基準点を調整
								var diffX = getOffsetX(targetEl) - getOffsetX(listEl);
								var diffY = getOffsetY(targetEl) - getOffsetY(listEl);
								basePos[0] += diffX;
								basePos[1] += diffY;
								moveX = event.pageX - basePos[0];
								moveY = event.pageY - basePos[1];
								$list.transitStop(true).transit({x: moveX + "px", y: moveY + "px"}, NOANIME_PARAMS);
								// 要素を入れ替えるとドラッグ基準点がずれるので、予め入れ替えた先の座標を元にドラッグ基準点を調整ここまで

								// 要素入れ替え
								$target[listIndex > targetIndex ? "before" : "after"]($list);
								$list.data("index", targetIndex);
								// 要素入れ替えここまで

								// 要素入れ替えによって、移動が必要な要素の座標が一気にずれてしまうため、
								// 保存しておいた座標に一時的に移動させてから、元に戻すアニメーションを行う
								$tmp.each(function (i, el) {
									el.style.willChange = "transform";
									var $el = $(el);
									var beforePos = $el.data("pos");
									moveX = beforePos[0] - getOffsetX(el);
									moveY = beforePos[1] - getOffsetY(el);
									$el.removeData("pos");
									$el.transitStop(true).transit({x: moveX + "px", y: moveY + "px"}, NOANIME_PARAMS).transit({x: 0, y: 0}, {duration: SWAP_ANIME_DURATION, complete: function () {
										el.removeAttribute("style");
									}});
								});
								// 要素入れ替えによって、移動が必要な要素の座標が一気にずれてしまうため、
								// 保存しておいた座標に一時的に移動させてから、元に戻すアニメーションを行うここまで
							}
						}
						if (distance) {
							var e = copyEvent(event);
							var animationStartTime = (new Date()).getTime();
							intervalTimerId = requestAnimationFrame(function () {
								e.rate = (new Date().getTime() - animationStartTime) / SCROLL_INTERVAL;
								intervalTimerId = null;
								// マウスイベントを強制発行することで自動スクロールを実現する
								$(window).trigger(e);
							}, SCROLL_INTERVAL);
						}
						return false;
					}).one(_.addLabel(_.addMouseEventName(_.end), ".drag.editmode"), function (event) {
						clearInterval(intervalTimerId);
						$list.transitStop(true).transit({x: 0, y: 0, scale: 1}, {duration: 300, complete: function () {
							listEl.removeAttribute("style");
							$list.removeClass("drag");
						}});
						if (window.COMMON.naviDevice1 == "3") {
							window.removeEventListener('touchmove', handleTouchMove, { passive: false });
						}
						$(window).off(".drag.editmode appenditem.mylist.editmode");
						$list.removeData("isTouch");
					});
				});
				if (window.COMMON.naviDevice1 === "3") {
					// iOS10からtouchstart中にtouchmove傍受開始してもスクロール制御が効かない
					// けど、とりあえず登録しておけば整合性がとれるっぽい
					$(window).on("touchmove.editmode", function () {});
				}
			}
			// 作品クリック時
			$itemModule.click(function (e) {
				if (e.isDefaultPrevented() || $(e.currentTarget).data("isMove") === true) {
					return false;
				}
				var $this = $(this);
				if ($this.hasClass("selected")) {
					$this.addClass("notSelected");
					$this.removeClass("selected");
				} else {
					$this.removeClass("notSelected");
					$this.addClass("selected");
				}
				setSelectMode(false);
				updateDeleteCount();
				return false;
			});

			// ソートクリック時
			$itemModule.find(".btnSort").click(function (e) {
				if (e.isDefaultPrevented() || $(e.currentTarget).data("isMove") === true) {
					return false;
				}
				var $this = $(this);
				var $currentItem = $this.parent().parent();
				var $prevItem = $currentItem.prev();
				var $nextItem = $currentItem.next();

				if (($this.hasClass("btnSortUp") && $prevItem.length === 0) ||
					($this.hasClass("btnSortDown") && $nextItem.length === 0)) {
					return false;
				}
				var prevOffset = $prevItem.offset();
				var nextOffset = $nextItem.offset();
				var currentOffset = $currentItem.offset();
				var $from, $to;
				var diffX, diffY, scrollTo;

				if ($this.hasClass("btnSortUp")) {
					$to = $currentItem;
					$from = $prevItem;
					diffY = prevOffset.top - currentOffset.top;
					diffX = prevOffset.left - currentOffset.left;
					scrollTo = "+=" + diffY;
				} else {
					$to = $nextItem;
					$from = $currentItem;
					diffY = currentOffset.top - nextOffset.top;
					diffX = currentOffset.left - nextOffset.left;
					scrollTo = "-=" + diffY;
				}

				$from.before($to);
				$to.transitStop(true, true).transit({x: -diffX + "px", y: -diffY + "px"}, {duration: 0}).transit({x: 0, y: 0}, {duration: 400});
				$from.transitStop(true, true).transit({x: diffX + "px", y: diffY + "px"}, {duration: 0}).transit({x: 0, y: 0}, {duration: 400});
				return false;
			});
		};
		// 追加されたDOMへの対応
		$(window).on("appenditem.mylist.editmode", setItemModuleEvent);
		setItemModuleEvent();

		// すべて選択クリック時
		$contentRoot.find(".btnSelectToggle").click(function () {
			var isClecked = $(this).hasClass("checked");
			setSelectMode(!isClecked);
			selectAll(!isClecked);
			updateDeleteCount();
		});

		// キャンセル
		$editFooter.find(".btnCancel").add(".btnEditCancel").click(function () {
			// 並び順を元に戻す
			var $el = $contentRoot.find(".itemModule.mybest").sort(function (a, b){
				a = parseInt($(a).attr("data-sort-index"), 10);
				b = parseInt($(b).attr("data-sort-index"), 10);
				if (a > b) { return 1; }
				if (a < b) { return -1; }
				return 0;
			});
			$el.each(function(index, el) {
				var $this = $(el);
				$this.parent().append($this);
			});

			closeEditMode();
			return false;
		});

		// 「リストから削除」ボタン押下時
		$editFooter.find("#mypageDel").click(function () {

			var selectIdList = [];
			var sortIdList = [];
			var isSordChanged = false;
			$contentRoot.find(".itemModule:not(.dmarket)").each(function (index, el) {
				var $el = $(el);
				var id = $el.find(".workId").val();
				// 「リストから削除」チェックのあるものだけをピックアップ
				if ($el.hasClass("selected")) {
					if (id) {
						selectIdList.push(id);
					}
				}
				var elementIndex = $el.data("sort-index");
				if (!isSordChanged) { isSordChanged = index === elementIndex; }
				sortIdList.push(id);
			});


			// チェックがない場合
			if (selectIdList.length === 0) {
				window.COMMON.showToast("何も選択されていません。");
			// チェックがある場合
			} else {
				window.COMMON.showDialog({
					title: "リストから削除",
					text: "選択された作品をリストから削除しますか？",
					button1Text: "キャンセル",
					button1Callback: function(){

					},
					button2Text: "削除する",
					button2Callback: function(){
						// サブミット用フォームを取得
						var obj = document.forms["hideRecordForm"];
						obj.hideTarget.value = selectIdList.join();

						// hidden項目「lastPageFlag」を取得
						var hidenObjForPaging = document.getElementById("lastPageFlag");

						// hiddne項目が存在したか？（公開マイリストはページングなしなのでnullとなる）
						if (hidenObjForPaging !== null) {
							// 最終ページで画面内全てチェックがある場合、前のページへ遷移させる
							if (document.getElementById("lastPageFlag").value === "1" && selectIdList.length === $(".itemModule").length) {
								obj.selectPage.value--;
							}
						}

						obj.action = document.getElementById("hideAction").value;
						obj.submit();
					}
				});
			}
			return false;
		});

		// マイリスト「リストから削除」ボタン押下時
		$editFooter.find("#mylistDel").click(function () {
			var selectIdList = [];
			var isSordChanged = false;
			var deleteList = [];
			$contentRoot.find(".itemModule:not(.dmarket)").each(function (index, el) {
				var $el = $(el);
				var id = $el.find("[data-workid]").attr("data-workid");
				// 「リストから削除」チェックのあるものだけをピックアップ
				if (id && $el.hasClass("selected")) {
					selectIdList.push(id);
					deleteList.push(el);
				}
			});

			// チェックがない場合
			if (selectIdList.length === 0) {
				window.COMMON.showToast("何も選択されていません。");
			// チェックがある場合
			} else {
				window.COMMON.showDialog({
					title: "マイリストから削除",
					text: "選択された作品を全てのマイリストから削除しますか？",
					button1Text: "キャンセル",
					button1Callback: function () {

					},
					button2Text: "削除する",
					button2Callback: function () {
						var postEndpoint = ""; // RestAPIのURL
						var postParams = { "updateType": "2" }; // RestAPIのPOSTパラメータ

						// registMyListへupdateType:"2"でリクエストすることでマイリストから削除
						postEndpoint = window.COMMON.RESTAPI_ENDPOINT.registMyList;
						postParams.workIdList =  selectIdList.join("_");

						window.COMMON.restPost(postEndpoint, postParams).done(function () {
							$(window).trigger("deleteitem.mylist", [$(deleteList).addClass("delete")]); // 削除したマイリストを通知(mylist-sharelist.jsで処理される)
							setSelectMode(false);
							updateDeleteCount();
							window.COMMON.showToast("削除しました");
						}).fail(function (errorCode) {
							switch (errorCode) {
							case "82": // 要アプリバージョンアップ
								window.location.href = "/animestore/iosapp_ver_warn";
								break;
							case "83": // 非対応機種
								window.location.href = "/animestore/uncov_m";
								break;
							case "84": // 要アプリ起動
								window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
								break;
							case "85": // 海外UA
								window.location.href = "/animestore/os_warn";
								break;
							case "86": // 未認証
							case "87": // 非会員
								window.location.href = "/animestore/login?next_url=" + encodeURIComponent(window.location.href);
								break;
							default:
								window.COMMON.showToast("エラーが発生しました");
								break;
							}
						});
					}
				});
			}
			return false;
		});

		// 公開リスト一覧「マイリストを削除」ボタン押下時
		$editFooter.find("#sharelistDel").click(function () {
			var selectIdList = [];
			$contentRoot.find(".itemModule:not(.dmarket)").each(function (index, el) {
				var $el = $(el);
				var id = $el.find(".shareListId").val();
				// 「リストから削除」チェックのあるものをピックアップ
				if ($el.is(".selected")) {
					if (id) {
						selectIdList.push(id);
					}
				}

			});

			if (selectIdList.length === 0) {
				window.COMMON.showToast("何も選択されていません。");
				return false;
			}

			window.COMMON.showDialog({
				title: "マイリスト削除",
				text: "選択されたマイリストを削除しますか？",
				button1Text: "キャンセル",
				button1Callback: function(){

				},
				button2Text: "削除する",
				button2Callback: function(){
					// サブミット用フォームを取得
					var obj = document.forms["deleteShareListsForm"];
					obj.shareListIdList.value = selectIdList.join();
					obj.action = document.getElementById("deleteAction").value;
					obj.submit();
				}
			});
			return false;
		});

		// 公開リスト「編集を確定」ボタン押下時
		$editFooter.find("#sharelistEdit").click(function () {

			var selectIdInfoList = [];
			var sortIdList = [];
			var deleteList = [];
			var isListChanged = false;
			var isNameChanged = false;
			var lastChangeIndex = -1;
			$contentRoot.find(".itemModule:not(.dmarket)").each(function (index, el) {
				var $el = $(el);
				var isSelected = $el.hasClass("selected");

				var id = $el.find("[data-workid]").attr("data-workid");
				if (id) {
					selectIdInfoList.push({
						"workId": id,
						"delete": isSelected ? 1 : 0
					});
					// 「リストから削除」チェックのあるものだけをピックアップ
					if (isSelected) {
						deleteList.push(el);
					}
				}
				var elementIndex = parseInt($el.attr("data-sort-index"), 10);

				// 並び順が代わっているか、選択されている場合
				if (index !== elementIndex || isSelected) {
					lastChangeIndex = index; // 最後の変更箇所を記憶する
					isListChanged = true;
				}
			});
			selectIdInfoList = selectIdInfoList.slice(0, lastChangeIndex + 1);

			var $editMyListName = $("#editMyListName");
			isNameChanged = $editMyListName.val() !== $editMyListName.attr("value");

			if (!isListChanged && !isNameChanged) {
				window.COMMON.showToast("何も変更されていません。");
				return false;
			// チェックがあるまたは順番が変わっている場合
			} else {
				// 公開リスト名の入力チェック
				var shareListName = $editMyListName.val().replace(/^[\s　]+|[\s　]+$/g, '');
				if (shareListName) {
					// サロゲートペア文字存在チェック
					if (shareListName.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g)) {
						window.COMMON.showToast("使用できない文字が含まれています");
						return false;
					}

					// 入力文字数チェック（最大：半角20文字相当※マルチバイト文字は2文字扱い）
					var len = 0;
					for (var i = 0; i < shareListName.length; i++) {
						// パーセントエンコード
						var encodedName = encodeURI(shareListName.charAt(i));
						// 2文字以上になったか？
						if (encodedName.length > 1) {
							// 半角2文字扱いとして加算
							len += 2;
						} else {
							len += 1;
						}
					}

					if (len > 20) {
						window.COMMON.showToast("リスト名は10文字以内で入力してください");
						return false;
					}
				} else {
					window.COMMON.showToast("名前が入力されていません");
					return false;
				}
			}

			window.COMMON.showDialog({
				title: "マイリスト編集",
				text: "マイリストを編集します。\nよろしいですか？",
				button1Text: "キャンセル",
				button1Callback: function () {

				},
				button2Text: "OK",
				button2Callback: function () {
					var shareListId = $("#shareListId").val() || window.COMMON.getSearch().shareListId;

					var changeNameDfd = new $.Deferred();
					if (isNameChanged) {
						var shareListName = $editMyListName.val().replace(/^[\s　]+|[\s　]+$/g, '');
						window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.registShareList, {
							"shareListId": shareListId,
							"shareListName": shareListName,
							"updateType": "1"
						}).done(function () {
							// 公開リストタイトルを設定された文字列で上書きする
							$("#myListName").find(".text").text(shareListName);
							$editMyListName.attr("value", shareListName);
							// SNS関連の公開リスト名を上書きする
							window.changeSnsTitle(shareListName);

							changeNameDfd.resolve();
						}).fail(function (errorCode) {
							changeNameDfd.resolve(errorCode);
						});
					} else {
						changeNameDfd.resolve(); // 変更がない場合は成功と同じパターンへ
					}

					var changeListDfd = new $.Deferred();
					if (isListChanged) {
						window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.editShareList, {
							"shareListId": shareListId,
							"workIdList": selectIdInfoList
						}).done(function () {
							// ソート順番を設定された並び順で上書きする
							$contentRoot.find(".itemModule").not(deleteList).each(function (index, el) {
								$(el).attr("data-sort-index", index);
							});
							$(window).trigger("deleteitem.mylist", [$(deleteList).addClass("delete")]); // 削除したマイリストを通知(mylist-sharelist.jsで処理される)
							setSelectMode(false);
							// updateDeleteCount(); // 公開リストの場合はボタンが「削除」ではないため不要
							changeListDfd.resolve();
						}).fail(function (errorCode) {
							changeListDfd.resolve(errorCode);
						});
					} else {
						changeListDfd.resolve(); // 変更がない場合は成功と同じパターンへ
					}

					$.when(changeNameDfd.promise(), changeListDfd.promise()).done(function (changeNameErrorCode, changeListErrorCode) {
						if (typeof changeNameErrorCode !== "undefined" || typeof changeListErrorCode !== "undefined") {
							var errorCode = changeNameErrorCode || changeListErrorCode; // 両方エラーだった場合は名前変更APIのエラーコードに従って処理される
							switch (errorCode) {
							case "82": // 要アプリバージョンアップ
								window.location.href = "/animestore/iosapp_ver_warn";
								break;
							case "83": // 非対応機種
								window.location.href = "/animestore/uncov_m";
								break;
							case "84": // 要アプリ起動
								window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
								break;
							case "85": // 海外UA
								window.location.href = "/animestore/os_warn";
								break;
							case "86": // 未認証
							case "87": // 非会員
								window.location.href = "/animestore/login?next_url=" + encodeURIComponent(window.location.href);
								break;
							default:
								window.COMMON.showToast("エラーが発生しました");
								break;
							}
						} else {
							window.COMMON.showToast("編集を確定しました");
						}
					});
				}
			});
			return false;
		});

		// editModeFlag(クエリパラメータ)とセットで利用する表示制御用Cookie発行
		window.COMMON.setCookie("edit_mode_show_control", 1, 365);

	};

	$(function () {
		// マイページ全般 「編集する」ボタン押下時
		$(".btnEdit").click(function () {
			$.setEditMode();
			return false;
		});
		// 公開リスト「このマイリストを削除」押下時
		$(".btnDeleteList").click(function () {
			window.COMMON.showDialog({
				title: "マイリスト編集",
				text: "このマイリストを削除しますか？",
				button1Text: "キャンセル",
				button1Callback: function () {

				},
				button2Text: "削除する",
				button2Callback: function () {
					var shareListId = $("#shareListId").val() || window.COMMON.getSearch().shareListId;
					window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.registShareList, {
						"shareListId": shareListId,
						"updateType": "2"
					}).done(function () {
						window.location.href = "/animestore/mpa_mylists" + ((window.COMMON.naviDevice1 === "6") ? "_pc" : "");
					}).fail(function (errorCode) {
						switch (errorCode) {
						case "82": // 要アプリバージョンアップ
							window.location.href = "/animestore/iosapp_ver_warn";
							break;
						case "83": // 非対応機種
							window.location.href = "/animestore/uncov_m";
							break;
						case "84": // 要アプリ起動
							window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
							break;
						case "85": // 海外UA
							window.location.href = "/animestore/os_warn";
							break;
						case "86": // 未認証
						case "87": // 非会員
							window.location.href = "/animestore/login?next_url=" + encodeURIComponent(window.location.href);
							break;
						default:
							window.COMMON.showToast("エラーが発生しました");
							break;
						}
					});
				}
			});
			return false;
		});
	});
})(this, this.document, this.jQuery);