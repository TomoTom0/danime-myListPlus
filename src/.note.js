/*!
 * ⢀⢀⢀⢀⢀⢀⢀⢀⣄⣔⣔⣗⣝⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⣞⢞⢾⢀⢀⢀⢀⢀⢀⢀⠰⡘⡔⢜⠔⢜⠌⡆⢔⢀⠄
 * ⢀⢀⢀⢀⢀⣀⢮⢯⣺⣪⡺⣜⢮⢮⡳⣕⡗⣗⢗⣳⢳⡳⡳⣓⡗⣗⢗⣳⢳⡳⡳⣓⡗⡗⡹⢨⠂⢀⢀⢀⢀⢀⢀⢨⡪⡨⠢⡣⡑⡱⢨⠢⢣⠱⡨⡂⡀
 * ⢀⢀⢀⠠⡲⣝⣕⣗⢵⢵⢝⢮⡳⡳⣝⢮⡺⡮⣳⢳⡳⣝⣝⢞⢞⢮⡳⣳⢳⢝⢝⠪⡊⡢⡊⡲⢀⢀⢀⢀⢀⢀⢀⢸⢽⡹⡵⣌⡪⡨⢢⠣⡑⢕⢌⢮⢮⡢
 * ⢀⢀⡠⡯⣫⣺⡪⡮⡳⣝⢽⢵⢝⣝⢮⡳⣝⢞⢮⡳⣝⢮⢮⡫⣏⢗⣝⠮⡋⡪⡘⡌⡪⠢⡱⡘⠄⢀⢀⢀⢀⢀⢀⢸⡳⣝⣝⢮⣺⣪⡢⠣⡑⡱⡬⣳⢳⢝⣖⢀
 * ⢀⣘⢮⢯⡺⣪⢮⢏⢯⢮⡳⣝⣕⡗⣗⣝⢮⣫⡳⣝⢮⡳⡳⣝⠮⡫⡘⡌⡊⡆⢕⢌⢪⢸⡰⣽⠁⢀⢀⢀⢀⢀⢀⢸⢘⢺⢼⢕⡗⣮⡺⣝⢮⡫⣞⢮⢫⢑⠕⢍
 * ⢠⣪⣳⢳⢝⢮⡳⡽⡹⡵⣝⢞⣜⡞⣞⢮⡳⡵⣝⢮⡳⡝⡝⢌⠪⢢⢑⢌⢪⠨⡢⡱⣎⣗⣝⢾⢀⢀⢀⢀⢀⢀⢀⢰⢑⢜⢮⡳⣝⢮⡺⡮⡳⣝⢮⡪⡢⡑⡅⡣⢡
 * ⣔⢧⡳⡽⡹⡵⣝⢽⡹⡵⣝⣕⣗⣝⢮⡳⣝⢞⢮⢳⢑⢕⢘⢌⠪⡊⠢⠑⠘⠈⠊⠋⠚⠪⠮⣻⠄⢀⢀⢀⢀⢀⢀⢰⣕⢗⣗⣝⢮⡳⣝⢮⡻⣪⡳⡽⣕⢧⡪⡘⠔⠄
 * ⢮⡳⣝⢮⢏⢯⢮⡳⣝⢞⢮⡺⣜⢮⡳⣝⢮⡫⡯⣆⠣⡂⡇⠊⠈⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠈⢀⢀⢀⢀⢀⢀⢀⣸⢮⡳⣕⢗⣗⣝⠮⡳⢹⠪⢯⡺⣪⡳⣝⢵⣕⠅
 * ⡳⣝⢮⡫⣏⢯⣺⢺⡪⡯⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡳⠅⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡘⢧⡻⣪⡳⡵⡡⡃⢎⠢⢍⢆⢛⢮⡫⡮⡳⣕⠇
 * ⣝⢮⡳⣝⢮⡳⣕⢷⢝⢽⣹⣪⡳⣝⢮⡳⡝⢌⢍⠗⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠸⡐⢍⢺⡪⡯⡦⡣⡑⢕⢑⢌⢮⡳⣝⢽⡹⡪⡁
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⢗⢵⢵⢝⢮⡳⣝⢎⢊⢆⠁⢀⢀⢀⢀⢀⢀⢀⢀⡠⠠⡄⡄⢄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢱⡱⣕⢷⢝⢮⡫⡮⡯⡳⡽⡹⡵⣝⠮⡣⠣⡑⠄
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢮⢏⢯⢮⢏⢷⢝⢮⡣⢱⢀⢀⢀⢀⢀⢀⢀⢀⡴⡫⣮⡳⣌⡪⡂⢇⢆⢀⢀⢀⢀⢀⢀⢀⢀⢼⢝⢮⡳⣝⢗⢽⣹⡪⣏⢯⡫⣋⢪⢘⢌⢪⠸⡀
 * ⣝⢮⡳⣝⢮⡳⣝⢮⡳⡽⣝⢮⣫⡳⡽⣕⢇⠕⢀⢀⢀⢀⢀⢀⢀⡸⠨⡫⢺⡺⣺⡪⡮⡢⡅⣃⢀⢀⢀⢀⢀⢀⢀⢸⢹⡳⣝⢮⣫⡳⡵⣝⢎⢇⠪⠢⡑⡌⢆⢕⢑⠄
 * ⢮⡳⣝⢮⡳⣝⢮⡳⣝⡞⡮⡳⡵⣝⢞⢮⡣⡃⢀⢀⢀⢀⢀⢀⢐⠸⡨⡊⡢⡱⠱⣝⢮⢯⡳⣲⢀⢀⢀⢀⢀⢀⢀⠸⡐⡜⢜⢓⢕⠝⡍⡢⢱⢐⢍⢪⢘⠌⡆⣕⢼⠅
 * ⡳⣝⢮⡳⣝⢮⡳⣝⢞⢮⡫⡯⡺⡮⣫⡳⡕⡂⢀⢀⢀⢀⢀⢀⢀⢇⢪⠨⡒⡌⢕⠔⢍⢺⢺⣺⠁⢀⢀⢀⢀⢀⢀⢡⢃⢎⢢⠱⡨⡊⡢⡑⢕⠌⡆⢕⢬⡺⣺⡪⡯⡃
 * ⣝⢮⡳⣝⢮⡳⣝⢮⣫⡳⣝⢮⡻⣪⡳⣝⢎⢌⢀⢀⢀⢀⢀⢀⢀⢱⠡⡱⡨⡊⢆⠣⠣⡑⡔⢍⢀⢀⢀⢀⢀⢀⢀⠌⡆⡪⠢⡱⢨⢊⢢⢑⢅⢕⢼⣪⡳⣝⢮⠺⡩⠂
 * ⢮⡳⣝⢮⡳⣝⢮⣳⡣⡯⡮⡳⣝⢮⡫⣮⢣⠪⡀⢀⢀⢀⢀⢀⢀⢀⠣⡊⡢⢪⢘⢌⢕⢑⠜⢀⢀⢀⢀⢀⢀⢀⢀⢸⢦⣑⢕⠸⡐⡅⣕⣜⢮⢯⡳⡳⡝⡪⠪⡘⡌⡂
 * ⡳⣝⢮⡳⣝⢮⡳⡵⣝⢮⡫⡯⡮⡳⣝⢮⡣⡑⡅⡀⢀⢀⢀⢀⢀⢀⢀⠈⠘⠐⠕⠌⠂⠁⢀⢀⢀⢀⢀⢀⢀⢀⢀⢼⡳⣓⣗⣝⢮⣫⡺⡼⣕⢗⠝⡌⢆⢕⢑⠕⢌⠂
 * ⣝⢮⡳⣝⢮⡳⡽⣕⢗⣗⣝⢮⡫⡯⡮⣳⢕⠌⡆⠥⡀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢘⢝⢮⡺⡼⣕⢗⣝⠞⡌⢆⠣⡊⡆⠕⡅⢕⡑⠅
 * ⢮⡳⣝⢮⡳⣝⡞⡮⡳⣕⢗⣗⣝⢮⢯⢮⡣⢱⢘⢌⠆⡄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⠢⣑⠱⡐⡕⣝⣞⢮⣳⠱⡑⠜⡌⡪⢌⢪⢘⢌⠆⢎⠂
 * ⡳⣝⢮⡳⣝⢞⢮⡫⡯⡮⡳⣕⣗⣝⢮⡳⡕⡑⡌⢆⠕⡜⠔⣄⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⡠⡐⢕⠸⡨⡂⡣⡱⢨⢺⢜⣕⡇⡕⠬⡱⢨⢊⢢⠱⡨⡂⢇⢕⠁
 * ⣝⢮⡳⣝⢮⢏⣗⣝⢮⡫⡯⡺⣜⢮⡳⣝⢎⢌⠪⡂⢇⠪⡊⡮⣻⡲⡦⡤⣠⣀⣠⣀⡠⢠⢐⢔⠱⡨⡊⡢⡃⢎⢌⢒⢜⠰⡱⣝⣞⢜⢌⢪⢨⠢⡑⡅⢕⢌⠪⡢⡱⡅
 * ⢮⡳⣝⢮⣫⡳⣕⢗⣗⢽⡹⣝⢮⡳⣝⢮⡣⡊⡪⡘⡌⡪⡂⡯⣺⣪⡳⣝⢞⢮⡺⣜⢮⡢⡱⢨⢊⢢⠱⡨⡊⢆⢕⢑⢌⢪⢸⡺⡼⡱⡐⢕⢔⢑⢕⢘⢌⢆⢷⢝⣝⠆
 * ⡳⣝⢮⣳⡣⡯⡮⣳⢳⡳⣝⢮⡳⣝⢮⡳⡕⢌⠆⡕⢌⢆⠪⣺⢺⢜⣞⢮⢏⣗⣝⢮⡳⣳⢪⠢⡑⡅⢕⠬⡘⢔⢑⢌⠆⡕⡱⣝⢮⢇⢎⢒⢌⠆⡕⡑⡔⡱⣝⢵⢝⡅
 * ⣝⢮⡳⡵⣝⢮⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢎⠢⡣⡊⢆⠕⢅⢗⢽⢕⣗⢽⢕⢧⣳⡳⣝⢮⢯⢎⢎⢌⢆⠣⣊⢪⢨⢂⢇⠪⡪⡮⡯⡪⢢⠱⡰⡑⡌⢆⢕⢘⢮⣫⡳⡅
 * ⢮⡳⡽⣕⢗⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡣⡑⡢⡑⡅⡣⡑⡽⡹⣕⣗⢽⡹⣕⢧⢯⢮⡳⣝⢭⡳⡔⢅⢕⠢⡱⡐⢕⢔⢑⠵⣝⢮⢇⢕⠱⡐⢕⢘⠔⡅⡣⣗⢗⣝⠆
 * ⡳⣝⢞⠮⠷⠽⠵⠽⠮⠷⠽⠮⡳⣝⡮⣳⢕⢸⠨⡢⢱⠨⡢⡫⡯⡺⡼⡵⠽⢪⡳⣝⢞⢞⢮⡳⡽⡹⣆⢕⢑⢌⠪⠂⠎⡢⡹⡪⣯⢪⠢⠱⠡⠣⠡⠣⠪⠸⠼⣕⣗⠅
 * ⣝⢮⣻⣀⣀⣀⣀⣀⣀⢀⢀⢀⣽⠂⠈⠈⠁⠈⠈⢀⢡⢃⠎⡮⡫⡯⡮⡇⢀⢼⢝⠮⡇⢀⡀⢀⡀⢀⢀⠠⡱⡘⡌⡀⠨⡢⢹⢝⢮⡣⡂⡀⡀⡀⡀⡀⡀⡀⢀⣺⢼⠅
 * ⢮⣳⣣⡳⣕⢗⠅⠁⣗⡝⢀⢰⣫⡳⣳⢳⡣⡊⢆⠕⡌⢆⢕⠁⠑⠑⠬⢀⢀⠪⡂⢇⢪⢑⢅⢣⠱⡁⢀⢌⢆⠪⡂⡀⠐⠁⠳⠽⣕⡇⡪⡨⢪⠈⠈⢌⠪⢀⢠⣗⢽⠅
 * ⡳⣕⢧⢯⢮⣻⠁⢀⠁⢀⡰⡯⣺⢺⣪⡳⡽⡸⡐⢕⢅⠣⡊⡢⠢⣀⢀⢀⠐⠑⢅⢣⢑⢌⠆⡕⠁⢀⠐⢕⢌⠪⢌⡀⠠⡠⡠⣀⢀⠈⢆⠕⡅⠅⢀⠁⢀⡄⣗⢗⢽⠅
 * ⢝⢮⡳⣝⡮⠊⢀⣰⢮⡫⣞⣝⢮⣳⡵⣝⣝⣝⣮⣒⢌⢪⠨⡪⡘⢀⢀⢔⢄⢀⢀⡕⢌⠆⠕⠈⢀⡄⢀⠑⢔⠕⢅⡀⠨⡢⢹⡪⡯⡎⢆⢣⠊⢀⡠⢢⠣⢪⡳⡽⡹⠅
 * ⢨⡳⣝⡎⢀⣀⢮⣳⢳⢝⣞⢼⠅⢀⢀⡀⢀⢀⢀⢀⡀⢵⡁⢀⢀⠄⢎⠆⡕⡩⡂⢎⢀⠁⡀⡄⢇⠪⡢⢀⢀⢱⠡⡀⠐⡅⡳⣝⣝⢎⠌⢀⢀⢔⠸⡐⢕⠱⣝⠞⡍
 * ⢀⢺⡺⡲⡳⣝⢵⡳⡽⣕⢗⢽⢝⡽⡽⣝⢽⢽⢽⢽⡹⣕⢗⡞⣆⢇⢕⢑⢌⠆⢎⢪⢐⠕⡌⡊⢆⠣⡊⡆⢆⠕⢅⠢⢌⢆⢳⣣⡳⡕⡱⡘⢔⠅⡕⢅⢣⢑⢅⠣⠂
 * ⢀⢀⠽⡹⣝⢮⡳⣝⢞⢮⡫⣏⣗⣝⢞⢮⡫⣮⡳⡳⣝⢮⡳⣝⢮⡳⣣⢕⡢⡃⡣⡊⡢⡱⡘⡌⡪⠪⡨⡸⡐⢍⢊⢪⠢⡱⢸⣪⡺⡕⢌⠪⡢⢱⢘⠌⡆⢕⠜⠌
 * ⢀⢀⠈⢝⢮⡳⣝⢮⣫⡳⣝⢮⡺⡼⡹⡵⣝⢮⡺⣝⢮⡳⣝⢮⡳⣝⢮⣳⢳⢵⢌⡊⢆⠕⡌⢆⠕⡅⡣⢢⢑⢅⢣⠡⡃⢎⢪⡞⡮⡇⡣⡱⡘⢔⢅⠕⢜⠰⠁
 * ⢀⢀⢀⢀⠑⢝⢮⡳⡵⣝⢮⡳⣝⢮⢏⢯⢮⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⡳⣝⢵⣝⢞⢮⢌⡊⢆⠕⡌⡪⢢⠱⡨⠢⡣⡑⡅⢧⡫⡯⡪⠢⡪⡨⡒⢔⢍⠜
 * ⢀⢀⢀⢀⢀⢀⠑⠹⢺⣪⡳⣝⢮⣫⣫⡳⡳⣝⢮⡳⣝⢮⡳⣝⢮⡳⣝⣝⢮⡳⣕⢯⣫⡳⡳⡥⡣⡑⢜⠰⡑⠬⡱⢨⠢⡑⣕⣝⢮⢇⢣⢊⢆⠪⠒⠁
 * ⢀⢀⢀⢀⢀⢀⢀⢀⢀⢀⠉⠊⠓⠑⠃⠋⠋⠊⠓⠙⠊⠓⠙⠊⠓⠙⠊⠊⠓⠙⠊⠓⠑⠙⠙⠊⠋⠚⠈⠊⠘⠈⠊⠂⠃⠑⠘⠊⠋⠊⠐⠁
 *
 *                © NTT docomo Anime Store inc, All Right Reserved.
 */
(function (window, document, $) {
	"use strict";
	var createCkeckListItem = function (val) {
		var dom = "";
		var isAdded = val.status === "1";
		var isMax = val.count >= 50;
		dom +=	"<div class=\"checkboxList clearfix" + (!isAdded && isMax ? " disabled" : "") + "\">"; // 最大件数登録済みで、未追加の場合は非活性
		dom +=		"<div class=\"checkbox" + (isAdded ? " entried on" : "") + "\" data-shareListId=\"" + val.shareListId + "\">"; // 追加済みの場合はentried(登録状態)、on(選択状態)を付加
		dom +=			"<i" + (isAdded ? " class=\"on\"" : "") + "></i>"; // 追加済みの場合はon(選択状態)を付加
		dom +=		"</div>";
		dom +=		"<div class=\"label" + (isMax ? " max" : "") + (isAdded ? " added" : "") + "\">"; // 最大件数登録済みの場合はmax(最大件数登録済み状態)、追加済みの場合はadded(選択状態)を付加
		dom +=			"<p class=\"title line1\">";
		dom +=				"<span>" + window.COMMON.escape(val.shareListName) + "</span>";
		dom +=				"<span class=\"comment onlyMax\">最大50件登録済みです</span>"; // onlyMax/onlyAdded/onlyDel/onlyAddの詳細表示条件はmodal.cssに規定(checkboxのentried/on、labelのmax/addedなどで表示制御)
		dom +=				"<span class=\"comment onlyAdded\">すでに登録済みです</span>";
		dom +=				"<span class=\"comment onlyDel\">このリストから削除されます</span>";
		dom +=				"<span class=\"comment onlyAdd\">このリストに追加されます</span>";
		dom +=			"</p>";
		dom +=			"<span class=\"count\">(" + val.count + ")</span>";
		dom +=		"</div>";
		dom +=	"</div>";
		return dom;
	};
	var createCheckListDom = function (list, isEdit) {
		var dom = "";
		dom +=	"<div class=\"modalAddMyListIn\">";
		dom +=		"<p>各リストに最大50件まで作品を追加することができます</p>";
		dom +=		"<div class=\"formContainer\">";
		dom +=			"<div class=\"formContainerWrapper\">";
		dom +=				"<div class=\"formContainerCover\"></div>";
		dom +=				"<div class=\"formContainerIn webkitScrollbar vertical\">";
		dom +=					"<form>";
		$.each(list, function (index, val) {
			dom +=				createCkeckListItem(val);
		});
		dom +=					"</form>";
		if (list.length < 20) {
			dom +=			"<div class=\"btnNewMyList\">新しいマイリストを作成<i class=\"icon iconCircleAdd\"></i></div>"; // マイリスト20件未満の場合のみ表示
		}
		dom +=			"</div>";
		dom +=		"</div>";
		if (isEdit) { // 編集の場合に表示
			dom +=	"<div class=\"btnDeleteAll checkboxList clearfix\">";
			dom +=		"<div class=\"checkbox\">";
			dom +=			"<i></i>";
			dom +=		"</div>";
			dom +=		"<div class=\"label\">";
			dom +=			"<p class=\"title line1\">";
			dom +=				"<span>すべてのリストから削除</span>";
			dom +=			"</p>";
			dom +=		"</div>";
			dom +=	"</div>";
		}
		dom +=		"</div>";
		dom +=	"</div>";

		return dom;
	};

	function showMyListEditDialog (workId, params) {
		return showMyListDialog(workId, $.extend({}, params, {isEdit: true}));
	}
	function showMyListAddDialog (workId, params) {
		return showMyListDialog(workId, $.extend({}, params, {isEdit: false}));
	}
	function showMyListDialog (workId, params) {
		workId = typeof workId === "number" ? workId.toString() : workId;

		var deferred = deferred || new $.Deferred();
		var url = window.COMMON.RESTAPI_ENDPOINT.getShareList + ((workId) ? "?workId=" + workId : "");
		var isEdit = params.isEdit;
		var isRecreate = params.isRecreate;
		window.COMMON.restGet(url).done(function (data) {
			data = (data && $.isArray(data.shareList)) ? data.shareList || [] : [];
			data = data.reverse();

			window.COMMON.showDialog($.extend({
				className: "addMyListDialog",
				title: isEdit ? "マイリスト編集" : "マイリストに追加", // 1つ以上マイリストに登録済みかどうかで切り分け
				contents: createCheckListDom(data, isEdit),
				button1Text: "<span class=\"notDeleteAll\">設定する</span><span class=\"onlyDeleteAll\">マイリストから削除する</span>",
				button1Callback: function (param) {
					var isDeleteAll = param.root.hasClass("deleteAll");
					var idEdited = param.root.hasClass("edited");

					if (isDeleteAll) {
						registMyList(workId, "2", function (result) {
							if (result) {
								deferred.resolve(true, 0);
							} else {
								deferred.reject();
							}
						});
					} else if (idEdited) {
						var regShareListIdList = [];
						var delShareListIdList = [];
						// 追加されたものを集計
						param.root.find(".checkbox:not(.entried).on").map(function (index, el) {
							return regShareListIdList.push($(el).data("sharelistid"));
						});
						// 削除されたものを集計
						param.root.find(".checkbox.entried:not(.on)").map(function (index, el) {
							return delShareListIdList.push($(el).data("sharelistid"));
						});

						// 変更の場合は、自身の公開リストから削除される場合に削除
						var isTargetDelete = $("#shareListId").length ? ($.inArray($("#shareListId").val(), delShareListIdList)) > -1 : false;

						editMyList(workId, regShareListIdList, delShareListIdList, isEdit, function (result) {
							if (result) {
								// チェックされている個数を設定
								deferred.resolve(isTargetDelete, param.root.find(".checkbox.on").length);
							} else {
								deferred.reject();
							}
						});
					} else {
						window.COMMON.showToast("エラーが発生しました");
						deferred.reject();
						return false;
					}
				},
				aftershow: function ($dialog) {
					var $formContainerIn = $(".formContainerIn");
					var formContainerIn = $formContainerIn[0];
					if (window.COMMON.osVer === "android4.1") {
						$dialog.find(".formContainerCover").css({
							top: "100%",
							height: "120px"
						});
					}
					if (isRecreate) {
						$formContainerIn.scrollTop(formContainerIn.scrollHeight - formContainerIn.clientHeight - $(".btnNewMyList").outerHeight());
					}
				},
				afterinit: function ($dialog) {
					var checkEdited = function () {
						// すべてのチェックボックスを取得
						var $checkbox = $dialog.find(".formContainerIn .checkboxList:not(.disabled) .checkbox");
						// 変更されてるかどうかを判定。変更されてるかどうかはentriedとonの真偽値が一致しているかどうかを見る
						if ($checkbox.length === $checkbox.filter(":not(.entried):not(.on), .entried.on").length) {
							$dialog.removeClass("edited");
						} else {
							$dialog.addClass("edited");
						}
					};
					var checkUncheckAll = function () {
						// チェックされているものがあるかを確認
						if ($dialog.find(".formContainerIn .checkboxList:not(.disabled) i.on").length) {
							$dialog.removeClass("uncheckAll");
						} else {
							$dialog.addClass("uncheckAll");
						}
					};
					// すべて削除チェックボックス操作
					$dialog.find(".btnDeleteAll").click(function () {
						if ($(this).find("i").hasClass("on")){
							$(this).find("i").removeClass("on");
							$dialog.removeClass("deleteAll");
						} else {
							$(this).find("i").addClass("on");
							$dialog.addClass("deleteAll");
						}
					});
					// 各リストチェックボックス操作
					$dialog.find(".formContainerIn .checkboxList:not(.disabled)").click(function () {
						if ($dialog.hasClass("deleteAll")) { //すべて削除チェック済みの場合は処理しない
							return;
						}
						if ($(this).find("i").hasClass("on")){
							$(this).find(".checkbox").removeClass("on").find("i").removeClass("on");
						} else {
							$(this).find(".checkbox").addClass("on").find("i").addClass("on");
						}
						checkUncheckAll();
						checkEdited();
					});

					// 新しいマイリストを作成を押したらモーダルを切り替え
					$dialog.find(".btnNewMyList").click(function () {
						if ($dialog.hasClass("deleteAll")) { //すべて削除チェック済みの場合は処理しない
							return;
						}
						var dom = "";
						dom +=	"<div class=\"modalNewMyListIn\">";
						dom +=		"<p>好きな名前のリストを作って作品を追加できます(最大20件まで)</p>";
						dom +=		"<form>";
						dom +=			"<input id=\"newMyListName\" type=\"text\" placeholder=\"好きな名前を入力して下さい\">";
						dom +=		"</form>";
						dom +=	"</div>";
						dom +=	"<script>";
						dom +=	"$(\"#newMyListName\").on(\"keydown\", function(e) {";
						dom +=		"if ((e.which && e.which === 13) || (e.keyCode && e.keyCode === 13)) {";
						dom +=			"return false;";
						dom +=		"} else {";
						dom +=			"return true;";
						dom +=		"}";
						dom +=	"});";
						dom +=	"</script>";
						var isClicked = false;
						window.COMMON.showDialog({
							title: "新しいマイリストを作成",
							contents: dom,
							button1Text: "作成する",
							button1Callback: function (param) {
								if (isClicked) {
									return false;
								}
								isClicked = true;
								var shareListName = param.root.find("#newMyListName").val().replace(/^[\s　]+|[\s　]+$/g, '');
								createShareList(shareListName, isEdit, workId, function (result) {
									isClicked = false;
									if (result) {
										showMyListDialog(workId, {isEdit: isEdit, isRecreate: true, fadeIn: function ($d, centeringFunc) {
											// 再生成時にちらつかないように処理順番を制御
											var $generalModal = $d.find(".generalModal");
											var $modalOverlay = $d.find(".modalOverlay");
											$generalModal.css("visibility", "hidden");
											$d.show();
											centeringFunc(function () {
												$generalModal.css("visibility", "visible");
											});
											$dialog.closeModal();
											param.root.closeModal();
										}}).done(function (isTargetDelete, myListNum) {
											deferred.resolve(isTargetDelete, myListNum);
										}).fail(function () {
											deferred.reject();
										});
									}
								});
								return false;
							}
						});
					});
				}
			}, params));
		}).fail(function (errorCode) {
			switch (errorCode) {
				case "86": // 未認証
				case "87": // 非会員
					window.doLogin(null, {
						type: "show_" + (isEdit ? "edit" : "add") + "dialog_mylist",
						data: {workId: workId},
						timing: "load pageshow"
					});
					break;
				default:
					window.COMMON.showToast("エラーが発生しました");
					break;
			}
			deferred.reject();
		});
		return deferred.promise();
	}

	// 公開リストを作成する
	function createShareList (shareListName, isEdit, workId, callback) {
		if (shareListName) {
			// サロゲートペア文字存在チェック
			if (shareListName.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g)) {
				window.COMMON.showToast("使用できない文字が含まれています");
				if (typeof callback === "function") {
					callback(false);
				}
				return;
			}

			// 入力文字数チェック（最大：半角20文字相当※マルチバイト文字は2文字扱い）
			var len = 0;
			for (var i = 0; i < shareListName.length; i++) {
				// パーセントエンコード
				var encodedName = encodeURI(shareListName.charAt(i));
				// 2文字以上になったか？
				if (encodedName.length > 1) {
					// 半角2文字扱いとして加算
					len += 2;
				} else {
					len += 1;
				}
			}

			if (len > 20) {
				window.COMMON.showToast("リスト名は10文字以内で入力してください");
				if (typeof callback === "function") {
					callback(false);
				}
				return;
			}

			window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.registShareList, {
				"shareListId": null,
				"shareListName": shareListName,
				"updateType": "1"
			}).done(function () {
				if (typeof callback === "function") {
					callback(true);
				}
			}).fail(function (errorCode) {
				switch (errorCode) {
					case "22": // 公開リスト件数超過
						window.COMMON.showToast("上限数に達しましたので、作成できません");
						break;
					case "82": // 要アプリバージョンアップ
						window.location.href = "/animestore/iosapp_ver_warn";
						break;
					case "83": // 非対応機種
						window.location.href = "/animestore/uncov_m";
						break;
					case "84": // 要アプリ起動
						window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
						break;
					case "85": // 海外UA
						window.location.href = "/animestore/os_warn";
						break;
					case "86": // 未認証
					case "87": // 非会員
						window.doLogin(null, {
							type: "create_shareList",
							data: {shareListName: shareListName, isEdit: isEdit, workId: workId},
							timing: "load pageshow"
						});
						break;
					default:
						window.COMMON.showToast("エラーが発生しました");
						break;
				}
				if (typeof callback === "function") {
					callback(false);
				}
			});
		} else {
			window.COMMON.showToast("名前が入力されていません");
			if (typeof callback === "function") {
				callback(false);
			}
		}
	}

	// 作品のマイリスト登録状況を編集(追加削除)する
	function editMyList (workId, regShareListIdList, delShareListIdList, isEdit, callback) {
		window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.registWorkToShareList, {
			workId: workId,
			regShareListIdList: regShareListIdList,
			delShareListIdList: delShareListIdList
		}).done(function () {
			if (typeof callback === "function") {
				callback(true);
			}
		}).fail(function (errorCode) {
			switch (errorCode) {
				case "22": // 公開リスト作品件数超過
					window.COMMON.showToast("エラーが発生しました");
					break;
				case "23": // マイリスト作品件数超過
					window.COMMON.showToast("マイリストの上限数に達しましたので、設定できません");
					break;
				case "24": // 公開期間外
					window.COMMON.showToast("この作品は現在公開されておりません");
					break;
				case "82": // 要アプリバージョンアップ
					window.location.href = "/animestore/iosapp_ver_warn";
					break;
				case "83": // 非対応機種
					window.location.href = "/animestore/uncov_m";
					break;
				case "84": // 要アプリ起動
					window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
					break;
				case "85": // 海外UA
					window.location.href = "/animestore/os_warn";
					break;
				case "86": // 未認証
				case "87": // 非会員
					window.doLogin(null, {
						type: "edit_mylist",
						data: {workId: workId, regShareListIdList: regShareListIdList, delShareListIdList: delShareListIdList, isEdit: isEdit},
						timing: "load pageshow"
					});
					break;
				default:
					window.COMMON.showToast("エラーが発生しました");
					break;
			}
			if (typeof callback === "function") {
				callback(false);
			}
		});
	}
	// 作品をマイリストへ登録・削除する(公開リストへの振り分けはされない)
	function registMyList (workId, updateType, callback) {
		window.COMMON.restPost(window.COMMON.RESTAPI_ENDPOINT.registMyList, {
			workId: workId,
			updateType: updateType
		}).done(function (data) {
			if (typeof callback === "function") {
				callback(true);
			}
		}).fail(function (errorCode) {
			switch (errorCode) {
				case "22": // 件数超過
					window.COMMON.showToast("マイリストの上限数に達しましたので、設定できません");
					break;
				case "23": // 公開期間外
					window.COMMON.showToast("この作品は現在公開されておりません");
					break;
				case "82": // 要アプリバージョンアップ
					window.location.href = "/animestore/iosapp_ver_warn";
					break;
				case "83": // 非対応機種
					window.location.href = "/animestore/uncov_m";
					break;
				case "84": // 要アプリ起動
					window.location.href = "/animestore/dapp_warn?next_url=" + encodeURIComponent(window.location.href);
					break;
				case "85": // 海外UA
					window.location.href = "/animestore/os_warn";
					break;
				case "86": // 未認証
				case "87": // 非会員
					window.doLogin(null, {
						type: (updateType === 1 ? "add" : "del") + "_mylist",
						data: {workId: workId},
						timing: "load pageshow"
					});
					break;
				default:
					window.COMMON.showToast("マイページへの登録に失敗しました");
					break;
			}
			if (typeof callback === "function") {
				callback(false);
			}
		});
	}
	var showMyListEditDialogAction = function (workId) {
		showMyListEditDialog(workId).done(function (isTargetDelete, myListNum) {
			var $target = $(".addMyList.edit.listen[data-workid=" + workId + "]");
			$target.find("input").prop("checked", myListNum > 0);
			if (isTargetDelete) {
				$(window).trigger("deleteitem.mylist", [$target]); // 削除したマイリストを通知(mylist-sharelist.jsで処理される)
			}
		}).fail(function () {
			// RestAPI呼び出し失敗したパターンなのでチェックボックスは変更しない
		});
	};
	var showMyListAddDialogAction = function (workId) {
		var func = function () {
			showMyListAddDialog(workId).done(function (isTargetDelete, myListNum) {
				var $target = $(".addMyList.add.listen[data-workid=" + workId + "]");
				$target.find("input").prop("checked", true);
				$target.find("label").text("マイリストから削除");
				if (isTargetDelete) {
					$(window).trigger("deleteitem.mylist", [$target]); // 削除したマイリストを通知(このケースは処理されない)
				}
			}).fail(function () {
				// RestAPI呼び出し失敗したパターンなのでチェックボックスは変更しない
			});
		};
		if (window.COMMON.memberStatus === "1") {
			window.COMMON.restGet(window.COMMON.RESTAPI_ENDPOINT.getMyListStatus + "?targetFlag=01&workIdList=" + workId).done(function (d) {
				var p = {};
				if (d && d.statusList) {
					$.each(d.statusList, function (index, val) {
						p[val.workId] = val.myListStatus;
					});
				}
				if (p[workId] !== "1") {
					func();
				} else {
					var $target = $(".addMyList.add.listen[data-workid=" + workId + "]");
					$target.find("input").prop("checked", true);
					$target.find("label").text("マイリストから削除");
					window.COMMON.showToast("すでに登録済みです");
				}
			}).fail(function () {
				// RestAPI呼び出し失敗したパターンなのでチェックボックスは変更しない
			});
		} else {
			func();
		}
	};

	var showMyListDelDialogAction = function (workId) {
		window.COMMON.showDialog({
			title: "マイリストから削除",
			text: "この作品を全てのマイリストから削除しますか？",
			button1Text: "キャンセル",
			button1Callback: function () {
			},
			button2Text: "削除する",
			button2Callback: function () {
				deleteMyListAction(workId);
			}
		});
	};

	window.setAuthAction("show_editdialog_mylist", function (d) {
		showMyListEditDialogAction(d.workId);
	});
	window.setAuthAction("show_adddialog_mylist", function (d) {
		showMyListAddDialogAction(d.workId);
	});
	window.setAuthAction("create_shareList", function (d) {
		createShareList(d.shareListName, d.isEdit, d.workId, function (result) {
			if (result) {
				if (d.isEdit) {
					showMyListEditDialogAction(d.workId);
				} else {
					showMyListAddDialogAction(d.workId);
				}
			}
		});
	});
	window.setAuthAction("edit_mylist", function (d) {
		editMyList(d.workId, d.regShareListIdList, d.delShareListIdList, d.isEdit, function (result) {
			if (result) {
				var url = window.COMMON.RESTAPI_ENDPOINT.getShareList + ((d.workId) ? "?workId=" + d.workId : "");
				window.COMMON.restGet(url).done(function (data) {
					data = (data && $.isArray(data.shareList)) ? data.shareList || [] : [];
					data = $.grep(data, function (val) { return val.status === "1"; });
					var isTargetDelete = $("#shareListId").length ? $.grep(data, function (val) { return $("#shareListId").val() === val.shareListId; }).length === 0 : false;

					var $target = $(".addMyList." + (d.isEdit ? "edit" : "add") + ".listen[data-workid=" + d.workId + "]");
					if (d.isEdit) {
						// 編集の場合アイコンだけ変更
						$target.find("input").prop("checked", data.length > 0);
					} else {
						// 登録の場合削除表示に変更
						$target.find("input").prop("checked", true);
						$target.find("label").text("マイリストから削除");
					}
					if (isTargetDelete) {
						$(window).trigger("deleteitem.mylist", [$target]); // 削除したマイリストを通知(mylist-sharelist.jsで処理される)
					}
				});
			}
		});
	});

	var deleteMyListAction = function (workId) {
		registMyList(workId, 2, function (result) {
			if (result) {
				var $target = $(".addMyList.add.listen[data-workid=" + workId + "]");
				$target.find("input").prop("checked", false);
				$target.find("label").text("マイリストに追加");
				$(window).trigger("deleteitem.mylist", [$target]); // 削除したマイリストを通知(mylist-sharelist.jsで処理される)
			}
		});
	};
	window.setAuthAction("del_mylist", function (d) {
		deleteMyListAction(d.workId);
	});

	var setItemModuleEvent = function () {
		$(".addMyList.edit").not(".listen").addClass("listen").click(function (event) {
			var $target = $(event.currentTarget);
			var workId = $target.attr("data-workid");
			showMyListEditDialogAction(workId);
			return false;
		});
		$(".addMyList.add").not(".listen").addClass("listen").click(function (event) {
			var $target = $(event.currentTarget);
			var workId = $target.attr("data-workid");
			if (workId) {
				if (!$target.find("input").is(":checked")) {
					showMyListAddDialogAction(workId);
				} else {
					showMyListDelDialogAction(workId);
				}
			}
			return false;
		});
	};
	$(function () {
		// 追加されたDOMへの対応
		$(window).on("appenditem.mylist", setItemModuleEvent);
		setItemModuleEvent();
	});

})(this, this.document, this.jQuery);
